<!-- saved from url=(0014)about:internet -->
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="2,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">classdef</span> Controller3DHZD_obj &lt; Controller_MARLO</span></span>
<span class="srcline"><span class="lineno"><a href="2,2" id="srcline2">  2</a></span><span class="line">    <span class="comment">%MIKHAILCONTROLLER Mikhail's controller.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,3" id="srcline3">  3</a></span><span class="line">    <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,4" id="srcline4">  4</a></span><span class="line">    <span class="comment">% Copyright   2015 Mikhail S. Jones</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,5" id="srcline5">  5</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,6" id="srcline6">  6</a></span><span class="line">    <span class="comment">% PUBLIC PROPERTIES =====================================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,7" id="srcline7">  7</a></span><span class="line">    <span class="keyword">properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,8" id="srcline8">  8</a></span><span class="line">        <span class="comment">% Step Duration (s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,9" id="srcline9">  9</a></span><span class="line">        <span class="var type0" id="S3T0U9">t0_step</span>@double = 0.35</span></span>
<span class="srcline"><span class="lineno"><a href="2,10" id="srcline10"> 10</a></span><span class="line">        <span class="comment">% Step Duration Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,11" id="srcline11"> 11</a></span><span class="line">        <span class="var type0" id="S5T0U14">t_gain</span>@double = -0.1    <span class="comment">% Atrias, 0.02</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,12" id="srcline12"> 12</a></span><span class="line">        <span class="comment">% Stance Leg P Gain (N*m/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,13" id="srcline13"> 13</a></span><span class="line">        <span class="var type0" id="S6T0U20">kp_st_leg</span>@double = 5000</span></span>
<span class="srcline"><span class="lineno"><a href="2,14" id="srcline14"> 14</a></span><span class="line">        <span class="comment">% Stance Leg D Gain (N*m*s/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,15" id="srcline15"> 15</a></span><span class="line">        <span class="var type0" id="S7T0U25">kd_st_leg</span>@double = 120</span></span>
<span class="srcline"><span class="lineno"><a href="2,16" id="srcline16"> 16</a></span><span class="line">        <span class="comment">% Swing Leg P Gain (N*m/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,17" id="srcline17"> 17</a></span><span class="line">        <span class="var type0" id="S8T0U30">kp_sw_leg</span>@double = 5000</span></span>
<span class="srcline"><span class="lineno"><a href="2,18" id="srcline18"> 18</a></span><span class="line">        <span class="comment">% Swing Leg D Gain (N*m*s/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,19" id="srcline19"> 19</a></span><span class="line">        <span class="var type0" id="S9T0U35">kd_sw_leg</span>@double = 120</span></span>
<span class="srcline"><span class="lineno"><a href="2,20" id="srcline20"> 20</a></span><span class="line">        <span class="comment">% Hip P Gain (N*m/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,21" id="srcline21"> 21</a></span><span class="line">        <span class="var type0" id="S10T0U40">kp_hip</span>@double = 1200</span></span>
<span class="srcline"><span class="lineno"><a href="2,22" id="srcline22"> 22</a></span><span class="line">        <span class="comment">% Hip D Gain (N*m*s/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,23" id="srcline23"> 23</a></span><span class="line">        <span class="var type0" id="S11T0U45">kd_hip</span>@double = 60</span></span>
<span class="srcline"><span class="lineno"><a href="2,24" id="srcline24"> 24</a></span><span class="line">        <span class="comment">% Virtual Spring P Gain (N/m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,25" id="srcline25"> 25</a></span><span class="line">        <span class="var type0" id="S12T0U50">kp_vs</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,26" id="srcline26"> 26</a></span><span class="line">        <span class="comment">% Virtual Spring D Gain (N/m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,27" id="srcline27"> 27</a></span><span class="line">        <span class="var type0" id="S13T0U55">kd_vs</span>@double = 200</span></span>
<span class="srcline"><span class="lineno"><a href="2,28" id="srcline28"> 28</a></span><span class="line">        <span class="comment">% Virtual Spring P Gain (N/m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,29" id="srcline29"> 29</a></span><span class="line">        <span class="var type0" id="S14T0U60">kp_yaw</span>@double = 0.05</span></span>
<span class="srcline"><span class="lineno"><a href="2,30" id="srcline30"> 30</a></span><span class="line">        <span class="comment">% Virtual Spring D Gain (N/m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,31" id="srcline31"> 31</a></span><span class="line">        <span class="var type0" id="S15T0U65">kd_yaw</span>@double = 0.2</span></span>
<span class="srcline"><span class="lineno"><a href="2,32" id="srcline32"> 32</a></span><span class="line">        <span class="comment">% Left A Motor Torque Scaling Factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,33" id="srcline33"> 33</a></span><span class="line">        <span class="var type0" id="S16T0U70">s_l_A</span>@double = 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,34" id="srcline34"> 34</a></span><span class="line">        <span class="comment">% Left B Motor Torque Scaling Factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,35" id="srcline35"> 35</a></span><span class="line">        <span class="var type0" id="S17T0U75">s_l_B</span>@double = 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,36" id="srcline36"> 36</a></span><span class="line">        <span class="comment">% Right A Motor Torque Scaling Factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,37" id="srcline37"> 37</a></span><span class="line">        <span class="var type0" id="S18T0U80">s_r_A</span>@double = 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,38" id="srcline38"> 38</a></span><span class="line">        <span class="comment">% Right B Motor Torque Scaling Factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,39" id="srcline39"> 39</a></span><span class="line">        <span class="var type0" id="S19T0U85">s_r_B</span>@double = 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,40" id="srcline40"> 40</a></span><span class="line">        <span class="comment">% Lower Force Threshold (N)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,41" id="srcline41"> 41</a></span><span class="line">        <span class="var type0" id="S20T0U90">thres_lo</span>@double = 100</span></span>
<span class="srcline"><span class="lineno"><a href="2,42" id="srcline42"> 42</a></span><span class="line">        <span class="comment">% Upper Force Threshold (N)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,43" id="srcline43"> 43</a></span><span class="line">        <span class="var type0" id="S21T0U95">thres_hi</span>@double = 200</span></span>
<span class="srcline"><span class="lineno"><a href="2,44" id="srcline44"> 44</a></span><span class="line">        <span class="comment">% Velocity Filter Time Constant (s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,45" id="srcline45"> 45</a></span><span class="line">        <span class="var type0" id="S22T0U100">tau</span>@double = 0.25</span></span>
<span class="srcline"><span class="lineno"><a href="2,46" id="srcline46"> 46</a></span><span class="line">        <span class="comment">% X Velocity Feed-Forward Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,47" id="srcline47"> 47</a></span><span class="line">        <span class="var type0" id="S23T0U105">dx_gain</span>@double = 0.0</span></span>
<span class="srcline"><span class="lineno"><a href="2,48" id="srcline48"> 48</a></span><span class="line">        <span class="comment">% X Velocity Error P Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,49" id="srcline49"> 49</a></span><span class="line">        <span class="var type0" id="S24T0U110">dx_err_p_gain</span>@double = 0.3</span></span>
<span class="srcline"><span class="lineno"><a href="2,50" id="srcline50"> 50</a></span><span class="line">        <span class="comment">% X Velocity Error D Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,51" id="srcline51"> 51</a></span><span class="line">        <span class="var type0" id="S25T0U115">dx_err_d_gain</span>@double = 0.2</span></span>
<span class="srcline"><span class="lineno"><a href="2,52" id="srcline52"> 52</a></span><span class="line">        <span class="comment">% Y Velocity Feed-Forward Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,53" id="srcline53"> 53</a></span><span class="line">        <span class="var type0" id="S26T0U120">dy_gain</span>@double = 0.4</span></span>
<span class="srcline"><span class="lineno"><a href="2,54" id="srcline54"> 54</a></span><span class="line">        <span class="comment">% Y Velocity Error P Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,55" id="srcline55"> 55</a></span><span class="line">        <span class="var type0" id="S27T0U125">dy_err_p_gain</span>@double = 0.2</span></span>
<span class="srcline"><span class="lineno"><a href="2,56" id="srcline56"> 56</a></span><span class="line">        <span class="comment">% Y Velocity Error D Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,57" id="srcline57"> 57</a></span><span class="line">        <span class="var type0" id="S28T0U130">dy_err_d_gain</span>@double = 0.1</span></span>
<span class="srcline"><span class="lineno"><a href="2,58" id="srcline58"> 58</a></span><span class="line">        <span class="comment">% Hip Offset (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,59" id="srcline59"> 59</a></span><span class="line">        <span class="var type0" id="S29T0U135">y0_offset</span>@double = 0.18</span></span>
<span class="srcline"><span class="lineno"><a href="2,60" id="srcline60"> 60</a></span><span class="line">        <span class="comment">% Hip Offset Gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,61" id="srcline61"> 61</a></span><span class="line">        <span class="var type0" id="S30T0U140">y0_gain</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,62" id="srcline62"> 62</a></span><span class="line">        <span class="comment">% Set hip to constant</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,63" id="srcline63"> 63</a></span><span class="line">        <span class="var type0" id="S31T0U145">isTest5</span>@logical = false</span></span>
<span class="srcline"><span class="lineno"><a href="2,64" id="srcline64"> 64</a></span><span class="line">        <span class="comment">% Test hip tracking</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,65" id="srcline65"> 65</a></span><span class="line">        <span class="var type0" id="S34T0U151">isTest7</span>@logical = false</span></span>
<span class="srcline"><span class="lineno"><a href="2,66" id="srcline66"> 66</a></span><span class="line">        <span class="comment">% Test hip gravity compensation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,67" id="srcline67"> 67</a></span><span class="line">        <span class="var type0" id="S35T0U157">isTest8</span>@logical = false</span></span>
<span class="srcline"><span class="lineno"><a href="2,68" id="srcline68"> 68</a></span><span class="line">        <span class="comment">% Test Virtual Contraint</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,69" id="srcline69"> 69</a></span><span class="line">        <span class="var type0" id="S36T0U163">isTest11</span>@logical = false</span></span>
<span class="srcline"><span class="lineno"><a href="2,70" id="srcline70"> 70</a></span><span class="line">        <span class="comment">% Test VC tracking</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,71" id="srcline71"> 71</a></span><span class="line">        <span class="var type0" id="S37T0U169">isTest12</span>@logical = false</span></span>
<span class="srcline"><span class="lineno"><a href="2,72" id="srcline72"> 72</a></span><span class="line">        <span class="comment">% Enable Yaw Control (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,73" id="srcline73"> 73</a></span><span class="line">        <span class="var type0" id="S38T0U175">EnableYawControl</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,74" id="srcline74"> 74</a></span><span class="line">        <span class="comment">% Hip Gravity Compensation Torque (Nm)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,75" id="srcline75"> 75</a></span><span class="line">        <span class="var type0" id="S39T0U180">uHipGravity</span>@double = 0.8</span></span>
<span class="srcline"><span class="lineno"><a href="2,76" id="srcline76"> 76</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,77" id="srcline77"> 77</a></span><span class="line">    <span class="keyword">end</span> <span class="comment">% properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,78" id="srcline78"> 78</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,79" id="srcline79"> 79</a></span><span class="line">    <span class="comment">% PROTECTED PROPERTIES ==================================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">properties</span> (Access = protected)</span></span>
<span class="srcline"><span class="lineno"><a href="2,81" id="srcline81"> 81</a></span><span class="line">        <span class="comment">% Current stance leg (1 == Left, -1 == Right)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,82" id="srcline82"> 82</a></span><span class="line">        <span class="var type0" id="S40T0U190">stanceLeg</span>@double = -1</span></span>
<span class="srcline"><span class="lineno"><a href="2,83" id="srcline83"> 83</a></span><span class="line">        <span class="comment">% Gait mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,84" id="srcline84"> 84</a></span><span class="line">        <span class="var type0" id="S41T0U196">gaitMode</span>@GaitMode</span></span>
<span class="srcline"><span class="lineno"><a href="2,85" id="srcline85"> 85</a></span><span class="line">        <span class="comment">% Time since last step (s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,86" id="srcline86"> 86</a></span><span class="line">        <span class="var type0" id="S43T0U200">t</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,87" id="srcline87"> 87</a></span><span class="line">        <span class="comment">%     X Center of Mass Offset (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,88" id="srcline88"> 88</a></span><span class="line">        <span class="var type0" id="S44T0U205">x_offset</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,89" id="srcline89"> 89</a></span><span class="line">        <span class="comment">%     Y Center of Mass Offset (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,90" id="srcline90"> 90</a></span><span class="line">        <span class="var type0" id="S45T0U210">y_offset</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,91" id="srcline91"> 91</a></span><span class="line">        <span class="comment">%     Z Center of Mass Offset (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,92" id="srcline92"> 92</a></span><span class="line">        <span class="var type0" id="S46T0U215">z_offset</span>@double = 0.2087</span></span>
<span class="srcline"><span class="lineno"><a href="2,93" id="srcline93"> 93</a></span><span class="line">        <span class="comment">% Heading (rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,94" id="srcline94"> 94</a></span><span class="line">        <span class="var type0" id="S47T0U220">q_yaw_tgt</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,95" id="srcline95"> 95</a></span><span class="line">        <span class="var type0" id="S48T0U225">q_yaw</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,96" id="srcline96"> 96</a></span><span class="line">        <span class="var type0" id="S49T0U230">dq_yaw</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,97" id="srcline97"> 97</a></span><span class="line">        <span class="comment">% Estimated X position (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,98" id="srcline98"> 98</a></span><span class="line">        <span class="var type0" id="S50T0U235">x_est</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,99" id="srcline99"> 99</a></span><span class="line">        <span class="comment">% Estimated Y position (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,100" id="srcline100">100</a></span><span class="line">        <span class="var type0" id="S51T0U240">y_est</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,101" id="srcline101">101</a></span><span class="line">        <span class="comment">% Estimated X velocity (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,102" id="srcline102">102</a></span><span class="line">        <span class="var type0" id="S52T0U245">dx_est</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,103" id="srcline103">103</a></span><span class="line">        <span class="comment">% Estimated Y velocity (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,104" id="srcline104">104</a></span><span class="line">        <span class="var type0" id="S53T0U250">dy_est</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,105" id="srcline105">105</a></span><span class="line">        <span class="comment">% Estimated average Y velocity of last step (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,106" id="srcline106">106</a></span><span class="line">        <span class="var type0" id="S54T0U255">dy_est_avg</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,107" id="srcline107">107</a></span><span class="line">        <span class="comment">% Target X velocity (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,108" id="srcline108">108</a></span><span class="line">        <span class="var type0" id="S55T0U260">dx_tgt</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,109" id="srcline109">109</a></span><span class="line">        <span class="comment">% Target Y velocity (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,110" id="srcline110">110</a></span><span class="line">        <span class="var type0" id="S56T0U265">dy_tgt</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,111" id="srcline111">111</a></span><span class="line">        <span class="comment">% Estimated X velocity of last step (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,112" id="srcline112">112</a></span><span class="line">        <span class="var type0" id="S57T0U270">dx_est_last</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,113" id="srcline113">113</a></span><span class="line">        <span class="comment">% Estimated Y velocity of last step (m/s)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,114" id="srcline114">114</a></span><span class="line">        <span class="var type0" id="S58T0U275">dy_est_last</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,115" id="srcline115">115</a></span><span class="line">        <span class="comment">% Storage for passing signals to output function</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,116" id="srcline116">116</a></span><span class="line">        <span class="var type0" id="S59T0U280">output</span>@double = zeros(2,1)</span></span>
<span class="srcline"><span class="lineno"><a href="2,117" id="srcline117">117</a></span><span class="line">        <span class="comment">% phase variable</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,118" id="srcline118">118</a></span><span class="line">        <span class="var type0" id="S61T0U288">sDDA</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,119" id="srcline119">119</a></span><span class="line">        <span class="var type0" id="S62T0U293">dsDDA</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,120" id="srcline120">120</a></span><span class="line">        <span class="var type0" id="S63T0U298">dsDDA_est</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,121" id="srcline121">121</a></span><span class="line">        <span class="var type0" id="S64T0U303">ds_last</span>@double = 0.1;</span></span>
<span class="srcline"><span class="lineno"><a href="2,122" id="srcline122">122</a></span><span class="line">        <span class="var type0" id="S65T0U308">thetaMin</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,123" id="srcline123">123</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,124" id="srcline124">124</a></span><span class="line">        <span class="var type0" id="S66T0U313">dx</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,125" id="srcline125">125</a></span><span class="line">        <span class="var type0" id="S67T0U318">dy</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,126" id="srcline126">126</a></span><span class="line">        <span class="var type0" id="S68T0U323">theta</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,127" id="srcline127">127</a></span><span class="line">        <span class="var type0" id="S69T0U328">tauPhase</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,128" id="srcline128">128</a></span><span class="line">        <span class="var type0" id="S70T0U333">hd_last</span>@double = zeros(4,1)</span></span>
<span class="srcline"><span class="lineno"><a href="2,129" id="srcline129">129</a></span><span class="line">        <span class="var type0" id="S71T0U341">dhd_last</span>@double = zeros(4,1)</span></span>
<span class="srcline"><span class="lineno"><a href="2,130" id="srcline130">130</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,131" id="srcline131">131</a></span><span class="line">        <span class="var type0" id="S72T0U349">dq_yaw_last</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,132" id="srcline132">132</a></span><span class="line">        <span class="var type0" id="S73T0U354">dq_yaw_est</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,133" id="srcline133">133</a></span><span class="line">        <span class="var type0" id="S74T0U359">dq_yaw_tgt</span>@double = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,134" id="srcline134">134</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,135" id="srcline135">135</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,136" id="srcline136">136</a></span><span class="line">        <span class="var type0" id="S75T0U364">leftHeight</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,137" id="srcline137">137</a></span><span class="line">        <span class="var type0" id="S76T0U369">rightHeight</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,138" id="srcline138">138</a></span><span class="line">        <span class="var type0" id="S77T0U374">rightBelieve</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,139" id="srcline139">139</a></span><span class="line">        <span class="var type0" id="S78T0U379">leftBelieve</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,140" id="srcline140">140</a></span><span class="line">        <span class="var type0" id="S79T0U384">hBelieve</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,141" id="srcline141">141</a></span><span class="line">        <span class="var type0" id="S80T0U389">PressTime</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,142" id="srcline142">142</a></span><span class="line">        <span class="var type0" id="S81T0U394">yawReset</span>@double = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,143" id="srcline143">143</a></span><span class="line">    <span class="keyword">end</span> <span class="comment">% properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,144" id="srcline144">144</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,145" id="srcline145">145</a></span><span class="line">    <span class="comment">% CONSTANT PROPERTIES ===================================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,146" id="srcline146">146</a></span><span class="line">    <span class="keyword">properties</span> (Constant = true, Hidden = true)</span></span>
<span class="srcline"><span class="lineno"><a href="2,147" id="srcline147">147</a></span><span class="line">        <span class="comment">% Center of mass offset trim increment (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,148" id="srcline148">148</a></span><span class="line">        <span class="var type0" id="S82T0U406">trimIncrement</span> = 0.005</span></span>
<span class="srcline"><span class="lineno"><a href="2,149" id="srcline149">149</a></span><span class="line">        <span class="comment">% Leg rotational spring constant (N*m/rad)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,150" id="srcline150">150</a></span><span class="line">        <span class="var type0" id="S83T0U409">ks_leg</span> = 2690.8    <span class="comment">% MARLO 8 mm spring</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,151" id="srcline151">151</a></span><span class="line"><span class="comment">%       ks_leg = 2.6908e+03*(3/2)^3    % MARLO 12 mm spring</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,152" id="srcline152">152</a></span><span class="line">        <span class="comment">% Torso mass (kg)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,153" id="srcline153">153</a></span><span class="line">        <span class="var type0" id="S84T0U412">m_torso</span> = 22.2</span></span>
<span class="srcline"><span class="lineno"><a href="2,154" id="srcline154">154</a></span><span class="line">        <span class="comment">% Total mass (kg)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,155" id="srcline155">155</a></span><span class="line">        <span class="var type0" id="S85T0U415">m_total</span> = 61.24    <span class="comment">% MARLO</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,156" id="srcline156">156</a></span><span class="line">        <span class="comment">% Leg mass (kg)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,157" id="srcline157">157</a></span><span class="line">        <span class="var type0" id="S86T0U419">m_leg</span>@double = 17.54</span></span>
<span class="srcline"><span class="lineno"><a href="2,158" id="srcline158">158</a></span><span class="line">        <span class="comment">% Gravity</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,159" id="srcline159">159</a></span><span class="line">        <span class="var type0" id="S87T0U423">g</span> = 9.81</span></span>
<span class="srcline"><span class="lineno"><a href="2,160" id="srcline160">160</a></span><span class="line">        <span class="comment">% Hip length</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,161" id="srcline161">161</a></span><span class="line">        <span class="var type0" id="S88T0U426">l_h</span> = 0.1831</span></span>
<span class="srcline"><span class="lineno"><a href="2,162" id="srcline162">162</a></span><span class="line">        <span class="comment">% Nominal Leg Length (m)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,163" id="srcline163">163</a></span><span class="line">        <span class="var type0" id="S89T0U430">l0_leg</span>@double = 0.96</span></span>
<span class="srcline"><span class="lineno"><a href="2,164" id="srcline164">164</a></span><span class="line">        <span class="comment">% Leg motor coulomb friction</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,165" id="srcline165">165</a></span><span class="line">        <span class="var type0" id="S90T0U434">f_c</span> = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,166" id="srcline166">166</a></span><span class="line">        <span class="comment">% Leg motor viscous friction</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,167" id="srcline167">167</a></span><span class="line">        <span class="var type0" id="S91T0U437">f_v</span> = 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,168" id="srcline168">168</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,169" id="srcline169">169</a></span><span class="line">    <span class="keyword">end</span> <span class="comment">% properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,170" id="srcline170">170</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,171" id="srcline171">171</a></span><span class="line">    <span class="comment">% PUBLIC METHODS ========================================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,172" id="srcline172">172</a></span><span class="line">    <span class="keyword">methods</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,173" id="srcline173">173</a></span><span class="line">        <span class="keyword">function</span> userSetup(<span class="var type0" id="S93T0U444">obj</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,174" id="srcline174">174</a></span><span class="line">            <span class="comment">%USERSETUP Initialize system object.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,175" id="srcline175">175</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,176" id="srcline176">176</a></span><span class="line">            <span class="comment">% Reset objects</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,177" id="srcline177">177</a></span><span class="line">            <span class="var type0" id="S93T0U448">obj</span>.gaitMode = GaitMode.Circle;</span></span>
<span class="srcline"><span class="lineno"><a href="2,178" id="srcline178">178</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,179" id="srcline179">179</a></span><span class="line">            <span class="comment">% Reset parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,180" id="srcline180">180</a></span><span class="line">            <span class="var type0" id="S93T0U456">obj</span>.t = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,181" id="srcline181">181</a></span><span class="line">            <span class="var type0" id="S93T0U462">obj</span>.x_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,182" id="srcline182">182</a></span><span class="line">            <span class="var type0" id="S93T0U468">obj</span>.y_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,183" id="srcline183">183</a></span><span class="line">            <span class="var type0" id="S93T0U474">obj</span>.dx_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,184" id="srcline184">184</a></span><span class="line">            <span class="var type0" id="S93T0U480">obj</span>.dy_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,185" id="srcline185">185</a></span><span class="line">            <span class="var type0" id="S93T0U486">obj</span>.dy_est_avg = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,186" id="srcline186">186</a></span><span class="line">            <span class="var type0" id="S93T0U492">obj</span>.dx_tgt = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,187" id="srcline187">187</a></span><span class="line">            <span class="var type0" id="S93T0U498">obj</span>.dy_tgt = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,188" id="srcline188">188</a></span><span class="line">            <span class="var type0" id="S93T0U504">obj</span>.dx_est_last = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,189" id="srcline189">189</a></span><span class="line">            <span class="var type0" id="S93T0U510">obj</span>.dy_est_last = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,190" id="srcline190">190</a></span><span class="line">            <span class="var type0" id="S93T0U516">obj</span>.dx = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,191" id="srcline191">191</a></span><span class="line">            <span class="var type0" id="S93T0U522">obj</span>.dy = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,192" id="srcline192">192</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S93T0U529">obj</span>.isSim == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,193" id="srcline193">193</a></span><span class="line">                <span class="var type0" id="S93T0U535">obj</span>.x_offset = -0.04;</span></span>
<span class="srcline"><span class="lineno"><a href="2,194" id="srcline194">194</a></span><span class="line">                <span class="var type0" id="S93T0U542">obj</span>.y_offset = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,195" id="srcline195">195</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,196" id="srcline196">196</a></span><span class="line">                <span class="var type0" id="S93T0U549">obj</span>.x_offset = -0.035;</span></span>
<span class="srcline"><span class="lineno"><a href="2,197" id="srcline197">197</a></span><span class="line">                <span class="var type0" id="S93T0U556">obj</span>.y_offset = 0.020;</span></span>
<span class="srcline"><span class="lineno"><a href="2,198" id="srcline198">198</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,199" id="srcline199">199</a></span><span class="line">            <span class="var type0" id="S93T0U562">obj</span>.q_yaw_tgt = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,200" id="srcline200">200</a></span><span class="line">            <span class="var type0" id="S93T0U568">obj</span>.dq_yaw_tgt = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,201" id="srcline201">201</a></span><span class="line">            <span class="var type0" id="S93T0U574">obj</span>.theta = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,202" id="srcline202">202</a></span><span class="line">            <span class="var type0" id="S93T0U580">obj</span>.sDDA = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,203" id="srcline203">203</a></span><span class="line">            <span class="var type0" id="S93T0U586">obj</span>.dsDDA = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,204" id="srcline204">204</a></span><span class="line">            <span class="var type0" id="S93T0U592">obj</span>.dsDDA_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,205" id="srcline205">205</a></span><span class="line">            <span class="var type0" id="S93T0U598">obj</span>.ds_last = 0.1;</span></span>
<span class="srcline"><span class="lineno"><a href="2,206" id="srcline206">206</a></span><span class="line">            <span class="var type0" id="S93T0U604">obj</span>.tauPhase = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,207" id="srcline207">207</a></span><span class="line">            <span class="var type0" id="S93T0U610">obj</span>.hd_last = [3.1774    3.1774    0.7148    0.7149]';</span></span>
<span class="srcline"><span class="lineno"><a href="2,208" id="srcline208">208</a></span><span class="line">            <span class="var type0" id="S93T0U622">obj</span>.dhd_last = zeros(4,1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,209" id="srcline209">209</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,210" id="srcline210">210</a></span><span class="line">            <span class="var type0" id="S93T0U631">obj</span>.dq_yaw_last = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,211" id="srcline211">211</a></span><span class="line">            <span class="var type0" id="S93T0U637">obj</span>.dq_yaw_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,212" id="srcline212">212</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,213" id="srcline213">213</a></span><span class="line">            <span class="var type0" id="S93T0U643">obj</span>.thetaMin = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,214" id="srcline214">214</a></span><span class="line">            <span class="var type0" id="S93T0U649">obj</span>.leftHeight = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,215" id="srcline215">215</a></span><span class="line">            <span class="var type0" id="S93T0U655">obj</span>.rightHeight = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,216" id="srcline216">216</a></span><span class="line">            <span class="var type0" id="S93T0U661">obj</span>.rightBelieve = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,217" id="srcline217">217</a></span><span class="line">            <span class="var type0" id="S93T0U667">obj</span>.leftBelieve = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,218" id="srcline218">218</a></span><span class="line">            <span class="var type0" id="S93T0U673">obj</span>.hBelieve = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,219" id="srcline219">219</a></span><span class="line">            <span class="var type0" id="S93T0U679">obj</span>.PressTime = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,220" id="srcline220">220</a></span><span class="line">            <span class="var type0" id="S93T0U685">obj</span>.yawReset = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,221" id="srcline221">221</a></span><span class="line">        <span class="keyword">end</span> <span class="comment">% userSetup</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,222" id="srcline222">222</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,223" id="srcline223">223</a></span><span class="line">        <span class="keyword">function</span> <span class="var type0" id="S96T0U690">userOut</span> = userOutput(<span class="var type0" id="S97T0U693">obj</span>,<span class="var type0" id="S98T0U694">q</span>,<span class="var type0" id="S99T0U695">dq</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,224" id="srcline224">224</a></span><span class="line">            <span class="comment">%USEROUTPUT User output function.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,225" id="srcline225">225</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,226" id="srcline226">226</a></span><span class="line">            <span class="var type0" id="S96T0U698">userOut</span> = [<span class="var type0" id="S97T0U702">obj</span>.dx_est,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,227" id="srcline227">227</a></span><span class="line">                <span class="var type0" id="S97T0U705">obj</span>.x_est,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,228" id="srcline228">228</a></span><span class="line">                <span class="var type0" id="S97T0U708">obj</span>.y_est,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,229" id="srcline229">229</a></span><span class="line">                <span class="var type0" id="S97T0U711">obj</span>.x_offset,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,230" id="srcline230">230</a></span><span class="line">                <span class="var type0" id="S97T0U714">obj</span>.y_offset,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,231" id="srcline231">231</a></span><span class="line">                <span class="var type0" id="S97T0U717">obj</span>.dx_est,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,232" id="srcline232">232</a></span><span class="line">                <span class="var type0" id="S97T0U720">obj</span>.dy_est,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,233" id="srcline233">233</a></span><span class="line">                <span class="var type0" id="S97T0U723">obj</span>.dx_tgt,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,234" id="srcline234">234</a></span><span class="line">                <span class="var type0" id="S97T0U727">obj</span>.output',<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,235" id="srcline235">235</a></span><span class="line">                <span class="var type0" id="S97T0U730">obj</span>.tauPhase,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,236" id="srcline236">236</a></span><span class="line">                <span class="var type0" id="S97T0U733">obj</span>.dx,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,237" id="srcline237">237</a></span><span class="line">                <span class="var type0" id="S97T0U736">obj</span>.dy,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,238" id="srcline238">238</a></span><span class="line">                <span class="var type0" id="S97T0U741">obj</span>.q_yaw*180/pi,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,239" id="srcline239">239</a></span><span class="line">                <span class="var type0" id="S97T0U747">obj</span>.dq_yaw,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,240" id="srcline240">240</a></span><span class="line">                <span class="var type0" id="S97T0U750">obj</span>.dq_yaw_est];</span></span>
<span class="srcline"><span class="lineno"><a href="2,241" id="srcline241">241</a></span><span class="line">            <span class="comment">%           userOut = [];</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,242" id="srcline242">242</a></span><span class="line">        <span class="keyword">end</span> <span class="comment">% userOutput</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,243" id="srcline243">243</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,244" id="srcline244">244</a></span><span class="line">        <span class="keyword">function</span> [<span class="var type0" id="S102T0U754">u</span>,<span class="var type0" id="S103T0U755">y_out</span>,<span class="var type0" id="S104T0U756">dy_out</span>] = userStep(<span class="var type0" id="S105T0U759">obj</span>, <span class="var type0" id="S106T0U760">q</span>, <span class="var type0" id="S107T0U761">dq</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,245" id="srcline245">245</a></span><span class="line">                <span class="var type0" id="S108T0U762">EnableTransition</span>, <span class="var type0" id="S109T0U763">theta_limits_norm</span>, <span class="var type0" id="S110T0U764">hAlphaSet</span>,<span class="var type0" id="S111T0U765">T</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,246" id="srcline246">246</a></span><span class="line">            <span class="comment">%USERSTEP System output and state update equations.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,247" id="srcline247">247</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,248" id="srcline248">248</a></span><span class="line">            <span class="comment">% Update stance duration timer</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,249" id="srcline249">249</a></span><span class="line">            <span class="var type0" id="S105T0U769">obj</span>.t = <span class="var type0" id="S105T0U773">obj</span>.t + <span class="var type0" id="S105T0U776">obj</span>.sampleInterval;</span></span>
<span class="srcline"><span class="lineno"><a href="2,250" id="srcline250">250</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,251" id="srcline251">251</a></span><span class="line">            <span class="comment">% Parse PS3 controller data</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,252" id="srcline252">252</a></span><span class="line">            parsePS3Controller(<span class="var type0" id="S105T0U781">obj</span>,<span class="var type0" id="S106T0U782">q</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,253" id="srcline253">253</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,254" id="srcline254">254</a></span><span class="line">            <span class="comment">% Relabel leg state variables in terms of stance and swing</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,255" id="srcline255">255</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U787">obj</span>.stanceLeg == 1 <span class="comment">% Left</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,256" id="srcline256">256</a></span><span class="line">                <span class="var type0" id="S113T0U792">q_st_mA</span> = <span class="var type0" id="S106T0U794">q</span>(8); <span class="var type0" id="S114T0U798">dq_st_mA</span> = <span class="var type0" id="S107T0U800">dq</span>(8); <span class="var type0" id="S115T0U804">q_st_mB</span> = <span class="var type0" id="S106T0U806">q</span>(6); <span class="var type0" id="S116T0U810">dq_st_mB</span> = <span class="var type0" id="S107T0U812">dq</span>(6);</span></span>
<span class="srcline"><span class="lineno"><a href="2,257" id="srcline257">257</a></span><span class="line">                <span class="var type0" id="S117T0U816">q_st_lA</span> = <span class="var type0" id="S106T0U818">q</span>(7); <span class="var type0" id="S118T0U822">dq_st_lA</span> = <span class="var type0" id="S107T0U824">dq</span>(7); <span class="var type0" id="S119T0U828">q_st_lB</span> = <span class="var type0" id="S106T0U830">q</span>(5); <span class="var type0" id="S120T0U834">dq_st_lB</span> = <span class="var type0" id="S107T0U836">dq</span>(5);</span></span>
<span class="srcline"><span class="lineno"><a href="2,258" id="srcline258">258</a></span><span class="line">                <span class="var type0" id="S121T0U840">q_st_h</span> = <span class="var type0" id="S106T0U842">q</span>(10); <span class="var type0" id="S122T0U846">dq_st_h</span> = <span class="var type0" id="S107T0U848">dq</span>(10);</span></span>
<span class="srcline"><span class="lineno"><a href="2,259" id="srcline259">259</a></span><span class="line">                <span class="var type0" id="S123T0U852">q_sw_mA</span> = <span class="var type0" id="S106T0U854">q</span>(4); <span class="var type0" id="S124T0U858">dq_sw_mA</span> = <span class="var type0" id="S107T0U860">dq</span>(4); <span class="var type0" id="S125T0U864">q_sw_mB</span> = <span class="var type0" id="S106T0U866">q</span>(2); <span class="var type0" id="S126T0U870">dq_sw_mB</span> = <span class="var type0" id="S107T0U872">dq</span>(2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,260" id="srcline260">260</a></span><span class="line">                <span class="var type0" id="S127T0U876">q_sw_lA</span> = <span class="var type0" id="S106T0U878">q</span>(3); <span class="var type0" id="S128T0U882">dq_sw_lA</span> = <span class="var type0" id="S107T0U884">dq</span>(3); <span class="var type0" id="S129T0U888">q_sw_lB</span> = <span class="var type0" id="S106T0U890">q</span>(1); <span class="var type0" id="S130T0U894">dq_sw_lB</span> = <span class="var type0" id="S107T0U896">dq</span>(1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,261" id="srcline261">261</a></span><span class="line">                <span class="var type0" id="S131T0U900">q_sw_h</span> = <span class="var type0" id="S106T0U902">q</span>(9); <span class="var type0" id="S132T0U906">dq_sw_h</span> = <span class="var type0" id="S107T0U908">dq</span>(9);</span></span>
<span class="srcline"><span class="lineno"><a href="2,262" id="srcline262">262</a></span><span class="line">            <span class="keyword">else</span> <span class="comment">% Right</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,263" id="srcline263">263</a></span><span class="line">                <span class="var type0" id="S113T0U913">q_st_mA</span> = <span class="var type0" id="S106T0U915">q</span>(4); <span class="var type0" id="S114T0U919">dq_st_mA</span> = <span class="var type0" id="S107T0U921">dq</span>(4); <span class="var type0" id="S115T0U925">q_st_mB</span> = <span class="var type0" id="S106T0U927">q</span>(2); <span class="var type0" id="S116T0U931">dq_st_mB</span> = <span class="var type0" id="S107T0U933">dq</span>(2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,264" id="srcline264">264</a></span><span class="line">                <span class="var type0" id="S117T0U937">q_st_lA</span> = <span class="var type0" id="S106T0U939">q</span>(3); <span class="var type0" id="S118T0U943">dq_st_lA</span> = <span class="var type0" id="S107T0U945">dq</span>(3); <span class="var type0" id="S119T0U949">q_st_lB</span> = <span class="var type0" id="S106T0U951">q</span>(1); <span class="var type0" id="S120T0U955">dq_st_lB</span> = <span class="var type0" id="S107T0U957">dq</span>(1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,265" id="srcline265">265</a></span><span class="line">                <span class="var type0" id="S121T0U961">q_st_h</span> = <span class="var type0" id="S106T0U963">q</span>(9); <span class="var type0" id="S122T0U967">dq_st_h</span> = <span class="var type0" id="S107T0U969">dq</span>(9);</span></span>
<span class="srcline"><span class="lineno"><a href="2,266" id="srcline266">266</a></span><span class="line">                <span class="var type0" id="S123T0U973">q_sw_mA</span> = <span class="var type0" id="S106T0U975">q</span>(8); <span class="var type0" id="S124T0U979">dq_sw_mA</span> = <span class="var type0" id="S107T0U981">dq</span>(8); <span class="var type0" id="S125T0U985">q_sw_mB</span> = <span class="var type0" id="S106T0U987">q</span>(6); <span class="var type0" id="S126T0U991">dq_sw_mB</span> = <span class="var type0" id="S107T0U993">dq</span>(6);</span></span>
<span class="srcline"><span class="lineno"><a href="2,267" id="srcline267">267</a></span><span class="line">                <span class="var type0" id="S127T0U997">q_sw_lA</span> = <span class="var type0" id="S106T0U999">q</span>(7); <span class="var type0" id="S128T0U1003">dq_sw_lA</span> = <span class="var type0" id="S107T0U1005">dq</span>(7); <span class="var type0" id="S129T0U1009">q_sw_lB</span> = <span class="var type0" id="S106T0U1011">q</span>(5); <span class="var type0" id="S130T0U1015">dq_sw_lB</span> = <span class="var type0" id="S107T0U1017">dq</span>(5);</span></span>
<span class="srcline"><span class="lineno"><a href="2,268" id="srcline268">268</a></span><span class="line">                <span class="var type0" id="S131T0U1021">q_sw_h</span> = <span class="var type0" id="S106T0U1023">q</span>(10); <span class="var type0" id="S132T0U1027">dq_sw_h</span> = <span class="var type0" id="S107T0U1029">dq</span>(10);</span></span>
<span class="srcline"><span class="lineno"><a href="2,269" id="srcline269">269</a></span><span class="line">            <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,270" id="srcline270">270</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,271" id="srcline271">271</a></span><span class="line">            <span class="comment">% Relabel torso state variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,272" id="srcline272">272</a></span><span class="line">            <span class="var type0" id="S133T0U1033">q_roll</span> = <span class="var type0" id="S106T0U1035">q</span>(11); <span class="var type0" id="S134T0U1039">dq_roll</span> = <span class="var type0" id="S107T0U1041">dq</span>(11);</span></span>
<span class="srcline"><span class="lineno"><a href="2,273" id="srcline273">273</a></span><span class="line">            <span class="var type0" id="S105T0U1046">obj</span>.q_yaw = <span class="var type0" id="S106T0U1050">q</span>(12) - <span class="var type0" id="S105T0U1053">obj</span>.yawReset; <span class="var type0" id="S105T0U1058">obj</span>.dq_yaw = <span class="var type0" id="S107T0U1061">dq</span>(12);</span></span>
<span class="srcline"><span class="lineno"><a href="2,274" id="srcline274">274</a></span><span class="line">            <span class="var type0" id="S135T0U1065">q_pitch</span> = <span class="var type0" id="S106T0U1067">q</span>(13); <span class="var type0" id="S136T0U1071">dq_pitch</span> = <span class="var type0" id="S107T0U1073">dq</span>(13);</span></span>
<span class="srcline"><span class="lineno"><a href="2,275" id="srcline275">275</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,276" id="srcline276">276</a></span><span class="line">            <span class="comment">% Calculate Swing foot height</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,277" id="srcline277">277</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U1079">obj</span>.stanceLeg == 1 <span class="comment">% Left</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,278" id="srcline278">278</a></span><span class="line">                <span class="var type0" id="S137T0U1084">q_st</span> = [<span class="var type0" id="S105T0U1089">obj</span>.q_yaw <span class="var type0" id="S133T0U1091">q_roll</span> <span class="var type0" id="S135T0U1092">q_pitch</span> <span class="var type0" id="S117T0U1093">q_st_lA</span> <span class="var type0" id="S119T0U1094">q_st_lB</span> <span class="var type0" id="S121T0U1095">q_st_h</span> <span class="var type0" id="S127T0U1096">q_sw_lA</span> <span class="var type0" id="S129T0U1097">q_sw_lB</span> -<span class="var type0" id="S131T0U1099">q_sw_h</span>]';</span></span>
<span class="srcline"><span class="lineno"><a href="2,279" id="srcline279">279</a></span><span class="line">                <span class="var type0" id="S137T0U1102">q_st</span> = [0 0 2*pi 2*pi 2*pi 0 2*pi 2*pi 0]' - <span class="var type0" id="S137T0U1131">q_st</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,280" id="srcline280">280</a></span><span class="line">                <span class="var type0" id="S139T0U1134">dq_st</span> = -[<span class="var type0" id="S105T0U1140">obj</span>.dq_yaw <span class="var type0" id="S134T0U1142">dq_roll</span> <span class="var type0" id="S136T0U1143">dq_pitch</span> <span class="var type0" id="S118T0U1144">dq_st_lA</span> <span class="var type0" id="S120T0U1145">dq_st_lB</span> <span class="var type0" id="S122T0U1146">dq_st_h</span> <span class="var type0" id="S128T0U1147">dq_sw_lA</span> <span class="var type0" id="S130T0U1148">dq_sw_lB</span> -<span class="var type0" id="S132T0U1150">dq_sw_h</span>]';</span></span>
<span class="srcline"><span class="lineno"><a href="2,281" id="srcline281">281</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,282" id="srcline282">282</a></span><span class="line">                <span class="var type0" id="S137T0U1154">q_st</span> = [<span class="var type0" id="S105T0U1159">obj</span>.q_yaw <span class="var type0" id="S133T0U1161">q_roll</span> <span class="var type0" id="S135T0U1162">q_pitch</span> <span class="var type0" id="S117T0U1163">q_st_lA</span> <span class="var type0" id="S119T0U1164">q_st_lB</span> -<span class="var type0" id="S121T0U1166">q_st_h</span> <span class="var type0" id="S127T0U1167">q_sw_lA</span> <span class="var type0" id="S129T0U1168">q_sw_lB</span> <span class="var type0" id="S131T0U1169">q_sw_h</span>]';</span></span>
<span class="srcline"><span class="lineno"><a href="2,283" id="srcline283">283</a></span><span class="line">                <span class="var type0" id="S137T0U1172">q_st</span> = [0 0 2*pi 2*pi 2*pi 0 2*pi 2*pi 0]' - <span class="var type0" id="S137T0U1201">q_st</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,284" id="srcline284">284</a></span><span class="line">                <span class="var type0" id="S139T0U1204">dq_st</span> = -[<span class="var type0" id="S105T0U1210">obj</span>.dq_yaw <span class="var type0" id="S134T0U1212">dq_roll</span> <span class="var type0" id="S136T0U1213">dq_pitch</span> <span class="var type0" id="S118T0U1214">dq_st_lA</span> <span class="var type0" id="S120T0U1215">dq_st_lB</span> -<span class="var type0" id="S122T0U1217">dq_st_h</span> <span class="var type0" id="S128T0U1218">dq_sw_lA</span> <span class="var type0" id="S130T0U1219">dq_sw_lB</span> <span class="var type0" id="S132T0U1220">dq_sw_h</span>]';</span></span>
<span class="srcline"><span class="lineno"><a href="2,285" id="srcline285">285</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,286" id="srcline286">286</a></span><span class="line">            [~, ~, ~, ~, <span class="var type0" id="S140T0U1228">p4L</span>, ~, ~, ~] = ATRIAS3D_FootPointPosJacob_Right(<span class="var type0" id="S137T0U1234">q_st</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,287" id="srcline287">287</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U1240">obj</span>.isSim == 0 &amp;&amp; <span class="var type0" id="S105T0U1245">obj</span>.stanceLeg == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,288" id="srcline288">288</a></span><span class="line">                <span class="var type0" id="S142T0U1250">footHeight</span> = <span class="var type0" id="S140T0U1253">p4L</span>(3)+0.015;</span></span>
<span class="srcline"><span class="lineno"><a href="2,289" id="srcline289">289</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S105T0U1260">obj</span>.isSim == 0 &amp;&amp; <span class="var type0" id="S105T0U1265">obj</span>.stanceLeg == -1</span></span>
<span class="srcline"><span class="lineno"><a href="2,290" id="srcline290">290</a></span><span class="line">                <span class="var type0" id="S142T0U1271">footHeight</span> = <span class="var type0" id="S140T0U1274">p4L</span>(3)-0.005;</span></span>
<span class="srcline"><span class="lineno"><a href="2,291" id="srcline291">291</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,292" id="srcline292">292</a></span><span class="line">                <span class="var type0" id="S142T0U1280">footHeight</span> = <span class="var type0" id="S140T0U1282">p4L</span>(3);</span></span>
<span class="srcline"><span class="lineno"><a href="2,293" id="srcline293">293</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,294" id="srcline294">294</a></span><span class="line">            <span class="comment">% Store heading for use in hold position mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,295" id="srcline295">295</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,296" id="srcline296">296</a></span><span class="line">            <span class="comment">% Hip lengths</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,297" id="srcline297">297</a></span><span class="line">            <span class="var type0" id="S143T0U1286">l_st_h</span> = <span class="var type0" id="S105T0U1289">obj</span>.l_h*<span class="var type0" id="S105T0U1292">obj</span>.stanceLeg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,298" id="srcline298">298</a></span><span class="line">            <span class="var type0" id="S144T0U1296">l_sw_h</span> = -<span class="var type0" id="S105T0U1300">obj</span>.l_h*<span class="var type0" id="S105T0U1303">obj</span>.stanceLeg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,299" id="srcline299">299</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,300" id="srcline300">300</a></span><span class="line">            <span class="comment">% Compute hip to center of mass distances and velocities</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,301" id="srcline301">301</a></span><span class="line">            <span class="var type0" id="S145T0U1307">x_t</span> = <span class="var type0" id="S105T0U1312">obj</span>.x_offset*cos(<span class="var type0" id="S135T0U1316">q_pitch</span>) + <span class="var type0" id="S105T0U1320">obj</span>.z_offset*cos(<span class="var type0" id="S133T0U1324">q_roll</span>)*sin(<span class="var type0" id="S135T0U1327">q_pitch</span>) + <span class="var type0" id="S105T0U1331">obj</span>.y_offset*sin(<span class="var type0" id="S135T0U1335">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1338">q_roll</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,302" id="srcline302">302</a></span><span class="line">            <span class="var type0" id="S148T0U1341">y_t</span> = <span class="var type0" id="S105T0U1345">obj</span>.y_offset*cos(<span class="var type0" id="S133T0U1349">q_roll</span>) - <span class="var type0" id="S105T0U1352">obj</span>.z_offset*sin(<span class="var type0" id="S133T0U1356">q_roll</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,303" id="srcline303">303</a></span><span class="line">            <span class="var type0" id="S149T0U1359">dx_t</span> = 0;<span class="comment">%obj.z_offset*cos(q_pitch)*cos(q_roll)*dq_pitch - obj.x_offset*sin(q_pitch)*dq_pitch + obj.y_offset*cos(q_pitch)*sin(q_roll)*dq_pitch + obj.y_offset*cos(q_roll)*sin(q_pitch)*dq_roll - obj.z_offset*sin(q_pitch)*sin(q_roll)*dq_roll;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,304" id="srcline304">304</a></span><span class="line">            <span class="var type0" id="S150T0U1363">dy_t</span> = 0;<span class="comment">%-(obj.z_offset*cos(q_roll) + obj.y_offset*sin(q_roll))*dq_roll;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,305" id="srcline305">305</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,306" id="srcline306">306</a></span><span class="line">            <span class="comment">% Compute toe to center of mass distances and velocities</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,307" id="srcline307">307</a></span><span class="line">            <span class="var type0" id="S105T0U1368">obj</span>.dx = (sin(<span class="var type0" id="S135T0U1406">q_pitch</span>)*sin(<span class="var type0" id="S117T0U1409">q_st_lA</span>)*<span class="var type0" id="S136T0U1410">dq_pitch</span>)/2 - (cos(<span class="var type0" id="S135T0U1418">q_pitch</span>)*cos(<span class="var type0" id="S119T0U1421">q_st_lB</span>)*<span class="var type0" id="S120T0U1422">dq_st_lB</span>)/2 - (cos(<span class="var type0" id="S135T0U1430">q_pitch</span>)*cos(<span class="var type0" id="S117T0U1433">q_st_lA</span>)*<span class="var type0" id="S118T0U1434">dq_st_lA</span>)/2 + (sin(<span class="var type0" id="S135T0U1442">q_pitch</span>)*sin(<span class="var type0" id="S119T0U1445">q_st_lB</span>)*<span class="var type0" id="S136T0U1446">dq_pitch</span>)/2 - <span class="var type0" id="S105T0U1451">obj</span>.x_offset*sin(<span class="var type0" id="S135T0U1455">q_pitch</span>)*<span class="var type0" id="S136T0U1456">dq_pitch</span> + <span class="var type0" id="S105T0U1461">obj</span>.z_offset*cos(<span class="var type0" id="S135T0U1465">q_pitch</span>)*cos(<span class="var type0" id="S133T0U1468">q_roll</span>)*<span class="var type0" id="S136T0U1469">dq_pitch</span> + <span class="var type0" id="S105T0U1474">obj</span>.y_offset*cos(<span class="var type0" id="S135T0U1478">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1481">q_roll</span>)*<span class="var type0" id="S136T0U1482">dq_pitch</span> + <span class="var type0" id="S105T0U1487">obj</span>.y_offset*cos(<span class="var type0" id="S133T0U1491">q_roll</span>)*sin(<span class="var type0" id="S135T0U1494">q_pitch</span>)*<span class="var type0" id="S134T0U1495">dq_roll</span> - <span class="var type0" id="S105T0U1500">obj</span>.z_offset*sin(<span class="var type0" id="S135T0U1504">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1507">q_roll</span>)*<span class="var type0" id="S134T0U1508">dq_roll</span> - (cos(<span class="var type0" id="S135T0U1517">q_pitch</span>)*cos(<span class="var type0" id="S133T0U1520">q_roll</span>)*cos(<span class="var type0" id="S121T0U1523">q_st_h</span>)*cos(<span class="var type0" id="S117T0U1526">q_st_lA</span>)*<span class="var type0" id="S136T0U1527">dq_pitch</span>)/2 - (cos(<span class="var type0" id="S135T0U1537">q_pitch</span>)*cos(<span class="var type0" id="S133T0U1540">q_roll</span>)*cos(<span class="var type0" id="S121T0U1543">q_st_h</span>)*cos(<span class="var type0" id="S119T0U1546">q_st_lB</span>)*<span class="var type0" id="S136T0U1547">dq_pitch</span>)/2 + (cos(<span class="var type0" id="S135T0U1557">q_pitch</span>)*cos(<span class="var type0" id="S117T0U1560">q_st_lA</span>)*sin(<span class="var type0" id="S133T0U1563">q_roll</span>)*sin(<span class="var type0" id="S121T0U1566">q_st_h</span>)*<span class="var type0" id="S136T0U1567">dq_pitch</span>)/2 + (cos(<span class="var type0" id="S135T0U1577">q_pitch</span>)*cos(<span class="var type0" id="S119T0U1580">q_st_lB</span>)*sin(<span class="var type0" id="S133T0U1583">q_roll</span>)*sin(<span class="var type0" id="S121T0U1586">q_st_h</span>)*<span class="var type0" id="S136T0U1587">dq_pitch</span>)/2 + (cos(<span class="var type0" id="S133T0U1597">q_roll</span>)*cos(<span class="var type0" id="S117T0U1600">q_st_lA</span>)*sin(<span class="var type0" id="S135T0U1603">q_pitch</span>)*sin(<span class="var type0" id="S121T0U1606">q_st_h</span>)*<span class="var type0" id="S134T0U1607">dq_roll</span>)/2 + (cos(<span class="var type0" id="S121T0U1617">q_st_h</span>)*cos(<span class="var type0" id="S117T0U1620">q_st_lA</span>)*sin(<span class="var type0" id="S135T0U1623">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1626">q_roll</span>)*<span class="var type0" id="S134T0U1627">dq_roll</span>)/2 + (cos(<span class="var type0" id="S133T0U1637">q_roll</span>)*cos(<span class="var type0" id="S119T0U1640">q_st_lB</span>)*sin(<span class="var type0" id="S135T0U1643">q_pitch</span>)*sin(<span class="var type0" id="S121T0U1646">q_st_h</span>)*<span class="var type0" id="S134T0U1647">dq_roll</span>)/2 + (cos(<span class="var type0" id="S121T0U1657">q_st_h</span>)*cos(<span class="var type0" id="S119T0U1660">q_st_lB</span>)*sin(<span class="var type0" id="S135T0U1663">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1666">q_roll</span>)*<span class="var type0" id="S134T0U1667">dq_roll</span>)/2 + (cos(<span class="var type0" id="S133T0U1677">q_roll</span>)*cos(<span class="var type0" id="S117T0U1680">q_st_lA</span>)*sin(<span class="var type0" id="S135T0U1683">q_pitch</span>)*sin(<span class="var type0" id="S121T0U1686">q_st_h</span>)*<span class="var type0" id="S122T0U1687">dq_st_h</span>)/2 + (cos(<span class="var type0" id="S121T0U1697">q_st_h</span>)*cos(<span class="var type0" id="S117T0U1700">q_st_lA</span>)*sin(<span class="var type0" id="S135T0U1703">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1706">q_roll</span>)*<span class="var type0" id="S122T0U1707">dq_st_h</span>)/2 + (cos(<span class="var type0" id="S133T0U1717">q_roll</span>)*cos(<span class="var type0" id="S119T0U1720">q_st_lB</span>)*sin(<span class="var type0" id="S135T0U1723">q_pitch</span>)*sin(<span class="var type0" id="S121T0U1726">q_st_h</span>)*<span class="var type0" id="S122T0U1727">dq_st_h</span>)/2 + (cos(<span class="var type0" id="S121T0U1737">q_st_h</span>)*cos(<span class="var type0" id="S119T0U1740">q_st_lB</span>)*sin(<span class="var type0" id="S135T0U1743">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1746">q_roll</span>)*<span class="var type0" id="S122T0U1747">dq_st_h</span>)/2 + (cos(<span class="var type0" id="S133T0U1757">q_roll</span>)*cos(<span class="var type0" id="S121T0U1760">q_st_h</span>)*sin(<span class="var type0" id="S135T0U1763">q_pitch</span>)*sin(<span class="var type0" id="S117T0U1766">q_st_lA</span>)*<span class="var type0" id="S118T0U1767">dq_st_lA</span>)/2 + (cos(<span class="var type0" id="S133T0U1777">q_roll</span>)*cos(<span class="var type0" id="S121T0U1780">q_st_h</span>)*sin(<span class="var type0" id="S135T0U1783">q_pitch</span>)*sin(<span class="var type0" id="S119T0U1786">q_st_lB</span>)*<span class="var type0" id="S120T0U1787">dq_st_lB</span>)/2 - <span class="var type0" id="S143T0U1793">l_st_h</span>*cos(<span class="var type0" id="S135T0U1796">q_pitch</span>)*cos(<span class="var type0" id="S133T0U1799">q_roll</span>)*sin(<span class="var type0" id="S121T0U1802">q_st_h</span>)*<span class="var type0" id="S136T0U1803">dq_pitch</span> - <span class="var type0" id="S143T0U1808">l_st_h</span>*cos(<span class="var type0" id="S135T0U1811">q_pitch</span>)*cos(<span class="var type0" id="S121T0U1814">q_st_h</span>)*sin(<span class="var type0" id="S133T0U1817">q_roll</span>)*<span class="var type0" id="S136T0U1818">dq_pitch</span> - <span class="var type0" id="S143T0U1823">l_st_h</span>*cos(<span class="var type0" id="S133T0U1826">q_roll</span>)*cos(<span class="var type0" id="S121T0U1829">q_st_h</span>)*sin(<span class="var type0" id="S135T0U1832">q_pitch</span>)*<span class="var type0" id="S134T0U1833">dq_roll</span> - <span class="var type0" id="S143T0U1838">l_st_h</span>*cos(<span class="var type0" id="S133T0U1841">q_roll</span>)*cos(<span class="var type0" id="S121T0U1844">q_st_h</span>)*sin(<span class="var type0" id="S135T0U1847">q_pitch</span>)*<span class="var type0" id="S122T0U1848">dq_st_h</span> - (sin(<span class="var type0" id="S135T0U1857">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1860">q_roll</span>)*sin(<span class="var type0" id="S121T0U1863">q_st_h</span>)*sin(<span class="var type0" id="S117T0U1866">q_st_lA</span>)*<span class="var type0" id="S118T0U1867">dq_st_lA</span>)/2 - (sin(<span class="var type0" id="S135T0U1877">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1880">q_roll</span>)*sin(<span class="var type0" id="S121T0U1883">q_st_h</span>)*sin(<span class="var type0" id="S119T0U1886">q_st_lB</span>)*<span class="var type0" id="S120T0U1887">dq_st_lB</span>)/2 + <span class="var type0" id="S143T0U1893">l_st_h</span>*sin(<span class="var type0" id="S135T0U1896">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1899">q_roll</span>)*sin(<span class="var type0" id="S121T0U1902">q_st_h</span>)*<span class="var type0" id="S134T0U1903">dq_roll</span> + <span class="var type0" id="S143T0U1908">l_st_h</span>*sin(<span class="var type0" id="S135T0U1911">q_pitch</span>)*sin(<span class="var type0" id="S133T0U1914">q_roll</span>)*sin(<span class="var type0" id="S121T0U1917">q_st_h</span>)*<span class="var type0" id="S122T0U1918">dq_st_h</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,308" id="srcline308">308</a></span><span class="line">            <span class="comment">% Full Derivation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,309" id="srcline309">309</a></span><span class="line">            <span class="comment">%             dy = l_st_h*cos(q_roll)*sin(q_st_h)*dq_roll - obj.y_offset*sin(q_roll)*dq_roll - (cos(q_st_lA)*sin(q_roll)*sin(q_st_h)*dq_roll)/2 - (cos(q_st_lB)*sin(q_roll)*sin(q_st_h)*dq_roll)/2 - (cos(q_st_lA)*sin(q_roll)*sin(q_st_h)*dq_st_h)/2 - (cos(q_st_lB)*sin(q_roll)*sin(q_st_h)*dq_st_h)/2 - (cos(q_roll)*sin(q_st_h)*sin(q_st_lA)*dq_st_lA)/2 - (cos(q_st_h)*sin(q_roll)*sin(q_st_lA)*dq_st_lA)/2 - (cos(q_roll)*sin(q_st_h)*sin(q_st_lB)*dq_st_lB)/2 - (cos(q_st_h)*sin(q_roll)*sin(q_st_lB)*dq_st_lB)/2 - obj.z_offset*cos(q_roll)*dq_roll + l_st_h*cos(q_st_h)*sin(q_roll)*dq_roll + l_st_h*cos(q_roll)*sin(q_st_h)*dq_st_h + l_st_h*cos(q_st_h)*sin(q_roll)*dq_st_h + (cos(q_roll)*cos(q_st_h)*cos(q_st_lA)*dq_roll)/2 + (cos(q_roll)*cos(q_st_h)*cos(q_st_lB)*dq_roll)/2 + (cos(q_roll)*cos(q_st_h)*cos(q_st_lA)*dq_st_h)/2 + (cos(q_roll)*cos(q_st_h)*cos(q_st_lB)*dq_st_h)/2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,310" id="srcline310">310</a></span><span class="line">            <span class="comment">% No torso offset</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,311" id="srcline311">311</a></span><span class="line">            <span class="var type0" id="S105T0U1922">obj</span>.dy = <span class="var type0" id="S143T0U1941">l_st_h</span>*cos(<span class="var type0" id="S133T0U1944">q_roll</span>)*sin(<span class="var type0" id="S121T0U1947">q_st_h</span>)*<span class="var type0" id="S134T0U1948">dq_roll</span> - (cos(<span class="var type0" id="S119T0U1956">q_st_lB</span>)*sin(<span class="var type0" id="S133T0U1959">q_roll</span>)*sin(<span class="var type0" id="S121T0U1962">q_st_h</span>)*<span class="var type0" id="S134T0U1963">dq_roll</span>)/2 - (cos(<span class="var type0" id="S117T0U1972">q_st_lA</span>)*sin(<span class="var type0" id="S133T0U1975">q_roll</span>)*sin(<span class="var type0" id="S121T0U1978">q_st_h</span>)*<span class="var type0" id="S122T0U1979">dq_st_h</span>)/2 - (cos(<span class="var type0" id="S119T0U1988">q_st_lB</span>)*sin(<span class="var type0" id="S133T0U1991">q_roll</span>)*sin(<span class="var type0" id="S121T0U1994">q_st_h</span>)*<span class="var type0" id="S122T0U1995">dq_st_h</span>)/2 - (cos(<span class="var type0" id="S133T0U2004">q_roll</span>)*sin(<span class="var type0" id="S121T0U2007">q_st_h</span>)*sin(<span class="var type0" id="S117T0U2010">q_st_lA</span>)*<span class="var type0" id="S118T0U2011">dq_st_lA</span>)/2 - (cos(<span class="var type0" id="S121T0U2020">q_st_h</span>)*sin(<span class="var type0" id="S133T0U2023">q_roll</span>)*sin(<span class="var type0" id="S117T0U2026">q_st_lA</span>)*<span class="var type0" id="S118T0U2027">dq_st_lA</span>)/2 - (cos(<span class="var type0" id="S133T0U2036">q_roll</span>)*sin(<span class="var type0" id="S121T0U2039">q_st_h</span>)*sin(<span class="var type0" id="S119T0U2042">q_st_lB</span>)*<span class="var type0" id="S120T0U2043">dq_st_lB</span>)/2 - (cos(<span class="var type0" id="S121T0U2052">q_st_h</span>)*sin(<span class="var type0" id="S133T0U2055">q_roll</span>)*sin(<span class="var type0" id="S119T0U2058">q_st_lB</span>)*<span class="var type0" id="S120T0U2059">dq_st_lB</span>)/2 + <span class="var type0" id="S143T0U2064">l_st_h</span>*cos(<span class="var type0" id="S121T0U2067">q_st_h</span>)*sin(<span class="var type0" id="S133T0U2070">q_roll</span>)*<span class="var type0" id="S134T0U2071">dq_roll</span> + <span class="var type0" id="S143T0U2075">l_st_h</span>*cos(<span class="var type0" id="S133T0U2078">q_roll</span>)*sin(<span class="var type0" id="S121T0U2081">q_st_h</span>)*<span class="var type0" id="S122T0U2082">dq_st_h</span> + <span class="var type0" id="S143T0U2086">l_st_h</span>*cos(<span class="var type0" id="S121T0U2089">q_st_h</span>)*sin(<span class="var type0" id="S133T0U2092">q_roll</span>)*<span class="var type0" id="S122T0U2093">dq_st_h</span> + (cos(<span class="var type0" id="S133T0U2101">q_roll</span>)*cos(<span class="var type0" id="S121T0U2104">q_st_h</span>)*cos(<span class="var type0" id="S117T0U2107">q_st_lA</span>)*<span class="var type0" id="S134T0U2108">dq_roll</span>)/2 + (cos(<span class="var type0" id="S133T0U2117">q_roll</span>)*cos(<span class="var type0" id="S121T0U2120">q_st_h</span>)*cos(<span class="var type0" id="S119T0U2123">q_st_lB</span>)*<span class="var type0" id="S134T0U2124">dq_roll</span>)/2 + (cos(<span class="var type0" id="S133T0U2133">q_roll</span>)*cos(<span class="var type0" id="S121T0U2136">q_st_h</span>)*cos(<span class="var type0" id="S117T0U2139">q_st_lA</span>)*<span class="var type0" id="S122T0U2140">dq_st_h</span>)/2 + (cos(<span class="var type0" id="S133T0U2149">q_roll</span>)*cos(<span class="var type0" id="S121T0U2152">q_st_h</span>)*cos(<span class="var type0" id="S119T0U2155">q_st_lB</span>)*<span class="var type0" id="S122T0U2156">dq_st_h</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,312" id="srcline312">312</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,313" id="srcline313">313</a></span><span class="line">            <span class="comment">% Estimated GRF</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,314" id="srcline314">314</a></span><span class="line">            <span class="var type0" id="S151T0U2160">fz_st</span> = 2*<span class="var type0" id="S105T0U2166">obj</span>.ks_leg*(cos(<span class="var type0" id="S135T0U2174">q_pitch</span> + <span class="var type0" id="S119T0U2175">q_st_lB</span>)*(<span class="var type0" id="S113T0U2178">q_st_mA</span> - <span class="var type0" id="S117T0U2179">q_st_lA</span>) - cos(<span class="var type0" id="S135T0U2184">q_pitch</span> + <span class="var type0" id="S117T0U2185">q_st_lA</span>)*(<span class="var type0" id="S115T0U2188">q_st_mB</span> - <span class="var type0" id="S119T0U2189">q_st_lB</span>))/sin(<span class="var type0" id="S117T0U2193">q_st_lA</span> - <span class="var type0" id="S119T0U2194">q_st_lB</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,315" id="srcline315">315</a></span><span class="line">            <span class="var type0" id="S152T0U2197">fz_sw</span> = 2*<span class="var type0" id="S105T0U2203">obj</span>.ks_leg*(cos(<span class="var type0" id="S135T0U2211">q_pitch</span> + <span class="var type0" id="S129T0U2212">q_sw_lB</span>)*(<span class="var type0" id="S123T0U2215">q_sw_mA</span> - <span class="var type0" id="S127T0U2216">q_sw_lA</span>) - cos(<span class="var type0" id="S135T0U2221">q_pitch</span> + <span class="var type0" id="S127T0U2222">q_sw_lA</span>)*(<span class="var type0" id="S125T0U2225">q_sw_mB</span> - <span class="var type0" id="S129T0U2226">q_sw_lB</span>))/sin(<span class="var type0" id="S127T0U2230">q_sw_lA</span> - <span class="var type0" id="S129T0U2231">q_sw_lB</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,316" id="srcline316">316</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,317" id="srcline317">317</a></span><span class="line">            <span class="comment">% Scaling factors representing a normalized vertical GRF</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,318" id="srcline318">318</a></span><span class="line">            <span class="var type0" id="S153T0U2234">s_st</span> = scaleFactor(<span class="var type0" id="S151T0U2237">fz_st</span>, <span class="var type0" id="S105T0U2239">obj</span>.thres_lo, <span class="var type0" id="S105T0U2242">obj</span>.thres_hi);</span></span>
<span class="srcline"><span class="lineno"><a href="2,319" id="srcline319">319</a></span><span class="line">            <span class="var type0" id="S155T0U2246">s_sw</span> = scaleFactor(<span class="var type0" id="S152T0U2249">fz_sw</span>, <span class="var type0" id="S105T0U2251">obj</span>.thres_lo, <span class="var type0" id="S105T0U2254">obj</span>.thres_hi);</span></span>
<span class="srcline"><span class="lineno"><a href="2,320" id="srcline320">320</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,321" id="srcline321">321</a></span><span class="line">            <span class="comment">% Compute smoothing factor based on confidence leg is on the ground</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,322" id="srcline322">322</a></span><span class="line">            <span class="var type0" id="S156T0U2258">alpha</span> = <span class="var type0" id="S153T0U2261">s_st</span>*<span class="var type0" id="S105T0U2263">obj</span>.sampleInterval/(<span class="var type0" id="S105T0U2268">obj</span>.tau + <span class="var type0" id="S105T0U2271">obj</span>.sampleInterval);</span></span>
<span class="srcline"><span class="lineno"><a href="2,323" id="srcline323">323</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,324" id="srcline324">324</a></span><span class="line">            <span class="comment">% Filter velocity estimate, ignoring bad (large) values</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,325" id="srcline325">325</a></span><span class="line">            <span class="var type0" id="S105T0U2276">obj</span>.dx_est = <span class="var type0" id="S105T0U2280">obj</span>.dx_est + <span class="var type0" id="S156T0U2284">alpha</span>*(<span class="var type0" id="S105T0U2288">obj</span>.dx - <span class="var type0" id="S105T0U2291">obj</span>.dx_est)*(abs(<span class="var type0" id="S105T0U2298">obj</span>.dx) &lt; 4);</span></span>
<span class="srcline"><span class="lineno"><a href="2,326" id="srcline326">326</a></span><span class="line">            <span class="var type0" id="S105T0U2304">obj</span>.dy_est = <span class="var type0" id="S105T0U2308">obj</span>.dy_est + <span class="var type0" id="S156T0U2312">alpha</span>*(<span class="var type0" id="S105T0U2316">obj</span>.dy - <span class="var type0" id="S105T0U2319">obj</span>.dy_est)*(abs(<span class="var type0" id="S105T0U2326">obj</span>.dy) &lt; 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,327" id="srcline327">327</a></span><span class="line">            <span class="var type0" id="S105T0U2332">obj</span>.dq_yaw_est = <span class="var type0" id="S105T0U2336">obj</span>.dq_yaw_est + <span class="var type0" id="S156T0U2340">alpha</span>*(<span class="var type0" id="S105T0U2344">obj</span>.dq_yaw - <span class="var type0" id="S105T0U2347">obj</span>.dq_yaw_est)*(abs(<span class="var type0" id="S105T0U2354">obj</span>.dq_yaw)&lt;0.5);</span></span>
<span class="srcline"><span class="lineno"><a href="2,328" id="srcline328">328</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,329" id="srcline329">329</a></span><span class="line">            <span class="comment">% Update CoM position estimates</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,330" id="srcline330">330</a></span><span class="line">            <span class="var type0" id="S105T0U2360">obj</span>.x_est = <span class="var type0" id="S105T0U2364">obj</span>.x_est + max(<span class="var type0" id="S153T0U2370">s_st</span>,<span class="var type0" id="S155T0U2371">s_sw</span>)*<span class="var type0" id="S105T0U2373">obj</span>.sampleInterval*(cos(<span class="var type0" id="S105T0U2381">obj</span>.q_yaw)*<span class="var type0" id="S105T0U2384">obj</span>.dx_est - sin(<span class="var type0" id="S105T0U2390">obj</span>.q_yaw)*<span class="var type0" id="S105T0U2393">obj</span>.dy_est);</span></span>
<span class="srcline"><span class="lineno"><a href="2,331" id="srcline331">331</a></span><span class="line">            <span class="var type0" id="S105T0U2398">obj</span>.y_est = <span class="var type0" id="S105T0U2402">obj</span>.y_est + max(<span class="var type0" id="S153T0U2408">s_st</span>,<span class="var type0" id="S155T0U2409">s_sw</span>)*<span class="var type0" id="S105T0U2411">obj</span>.sampleInterval*(sin(<span class="var type0" id="S105T0U2419">obj</span>.q_yaw)*<span class="var type0" id="S105T0U2422">obj</span>.dx_est + cos(<span class="var type0" id="S105T0U2428">obj</span>.q_yaw)*<span class="var type0" id="S105T0U2431">obj</span>.dy_est);</span></span>
<span class="srcline"><span class="lineno"><a href="2,332" id="srcline332">332</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,333" id="srcline333">333</a></span><span class="line">            <span class="comment">% Step duration</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,334" id="srcline334">334</a></span><span class="line">            <span class="var type0" id="S159T0U2435">t_step</span> = <span class="var type0" id="S105T0U2438">obj</span>.t0_step - clamp(<span class="var type0" id="S105T0U2444">obj</span>.t_gain*abs(<span class="var type0" id="S105T0U2449">obj</span>.dx_est), -0.1, 0.1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,335" id="srcline335">335</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,336" id="srcline336">336</a></span><span class="line">            <span class="comment">% Define a time variant parameter normalized between 0 and 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,337" id="srcline337">337</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S108T0U2457">EnableTransition</span> == 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,338" id="srcline338">338</a></span><span class="line">                <span class="var type0" id="S159T0U2461">t_step</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="2,339" id="srcline339">339</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,340" id="srcline340">340</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,341" id="srcline341">341</a></span><span class="line">            <span class="comment">% Compute state phase variable</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,342" id="srcline342">342</a></span><span class="line">            <span class="var type0" id="S105T0U2466">obj</span>.theta = <span class="var type0" id="S135T0U2469">q_pitch</span> + (<span class="var type0" id="S117T0U2473">q_st_lA</span>+<span class="var type0" id="S119T0U2474">q_st_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,343" id="srcline343">343</a></span><span class="line">            <span class="var type0" id="S161T0U2478">dtheta</span> = <span class="var type0" id="S136T0U2480">dq_pitch</span> + (<span class="var type0" id="S118T0U2484">dq_st_lA</span>+<span class="var type0" id="S120T0U2485">dq_st_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,344" id="srcline344">344</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,345" id="srcline345">345</a></span><span class="line">            <span class="var type0" id="S162T0U2489">dxInput</span> = clamp(<span class="var type0" id="S105T0U2493">obj</span>.dx_est,-0.8,1.2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,346" id="srcline346">346</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,347" id="srcline347">347</a></span><span class="line">            <span class="comment">%               dxSet = -0.8:0.2:0.8; %DataOneStep_20-Nov-2015_night_v</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,348" id="srcline348">348</a></span><span class="line">            <span class="var type0" id="S163T0U2500">dxSet</span> = -0.6:0.2:1;   <span class="comment">%RoughtGroundData_LK_16-Feb-2016</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,349" id="srcline349">349</a></span><span class="line">            <span class="var type0" id="S164T0U2509">hSet</span> = -0.1:0.1:0.1;</span></span>
<span class="srcline"><span class="lineno"><a href="2,350" id="srcline350">350</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,351" id="srcline351">351</a></span><span class="line">            [<span class="var type0" id="S165T0U2519">theta_limits</span>,~,~] = thetaLimitSet(<span class="var type0" id="S109T0U2524">theta_limits_norm</span>,<span class="var type0" id="S163T0U2525">dxSet</span>,<span class="var type0" id="S162T0U2526">dxInput</span>); <span class="comment">% interpolate Bezier</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,352" id="srcline352">352</a></span><span class="line">            <span class="var type0" id="S165T0U2530">theta_limits</span>(2) = <span class="var type0" id="S105T0U2533">obj</span>.thetaMin;</span></span>
<span class="srcline"><span class="lineno"><a href="2,353" id="srcline353">353</a></span><span class="line">            <span class="keyword">if</span> abs(<span class="var type0" id="S165T0U2542">theta_limits</span>(1)-<span class="var type0" id="S165T0U2545">theta_limits</span>(2))&lt;20*pi/180</span></span>
<span class="srcline"><span class="lineno"><a href="2,354" id="srcline354">354</a></span><span class="line">                <span class="var type0" id="S165T0U2556">theta_limits</span>(1) = 20*pi/180*sign(<span class="var type0" id="S165T0U2570">theta_limits</span>(1)-<span class="var type0" id="S165T0U2573">theta_limits</span>(2)) + <span class="var type0" id="S105T0U2576">obj</span>.thetaMin;</span></span>
<span class="srcline"><span class="lineno"><a href="2,355" id="srcline355">355</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,356" id="srcline356">356</a></span><span class="line">            <span class="var type0" id="S105T0U2581">obj</span>.sDDA = (<span class="var type0" id="S105T0U2587">obj</span>.theta-<span class="var type0" id="S165T0U2590">theta_limits</span>(2))/(<span class="var type0" id="S165T0U2595">theta_limits</span>(1)-<span class="var type0" id="S165T0U2598">theta_limits</span>(2));</span></span>
<span class="srcline"><span class="lineno"><a href="2,357" id="srcline357">357</a></span><span class="line">            <span class="var type0" id="S105T0U2603">obj</span>.dsDDA = <span class="var type0" id="S161T0U2606">dtheta</span>/(<span class="var type0" id="S165T0U2610">theta_limits</span>(1)-<span class="var type0" id="S165T0U2613">theta_limits</span>(2));</span></span>
<span class="srcline"><span class="lineno"><a href="2,358" id="srcline358">358</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,359" id="srcline359">359</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U2619">obj</span>.isTest11 == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,360" id="srcline360">360</a></span><span class="line">                <span class="var type0" id="S168T0U2624">beta</span> = <span class="var type0" id="S105T0U2627">obj</span>.sampleInterval/(<span class="var type0" id="S105T0U2632">obj</span>.tau + <span class="var type0" id="S105T0U2635">obj</span>.sampleInterval);</span></span>
<span class="srcline"><span class="lineno"><a href="2,361" id="srcline361">361</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,362" id="srcline362">362</a></span><span class="line">                <span class="var type0" id="S168T0U2640">beta</span> = <span class="var type0" id="S156T0U2641">alpha</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,363" id="srcline363">363</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,364" id="srcline364">364</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,365" id="srcline365">365</a></span><span class="line">            <span class="var type0" id="S105T0U2645">obj</span>.dsDDA_est = <span class="var type0" id="S105T0U2649">obj</span>.dsDDA_est + <span class="var type0" id="S168T0U2653">beta</span>*(<span class="var type0" id="S105T0U2657">obj</span>.dsDDA - <span class="var type0" id="S105T0U2660">obj</span>.dsDDA_est)*(abs(<span class="var type0" id="S105T0U2667">obj</span>.dsDDA &lt; 10));</span></span>
<span class="srcline"><span class="lineno"><a href="2,366" id="srcline366">366</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,367" id="srcline367">367</a></span><span class="line">            <span class="comment">%       alpha_L = scaleFactor(obj.dx_est, 0.4, 0.8)*50*(abs(obj.dx_est_last-obj.dx_est)&lt;0.15);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,368" id="srcline368">368</a></span><span class="line">            <span class="comment">%           alpha_L = scaleFactor(abs((obj.dx_est + obj.dx_tgt)/2), 0.4, 1)*10*(abs(obj.dx_est - obj.dx_tgt)&lt;0.4);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,369" id="srcline369">369</a></span><span class="line">            <span class="var type0" id="S169T0U2672">alpha_L</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,370" id="srcline370">370</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,371" id="srcline371">371</a></span><span class="line">            <span class="comment">% Phase Estimator</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,372" id="srcline372">372</a></span><span class="line">            <span class="var type0" id="S105T0U2677">obj</span>.tauPhase = <span class="var type0" id="S105T0U2681">obj</span>.tauPhase + <span class="var type0" id="S105T0U2685">obj</span>.sampleInterval*(1/<span class="var type0" id="S159T0U2691">t_step</span> + <span class="var type0" id="S169T0U2693">alpha_L</span>*(<span class="var type0" id="S105T0U2697">obj</span>.sDDA - <span class="var type0" id="S105T0U2700">obj</span>.tauPhase));</span></span>
<span class="srcline"><span class="lineno"><a href="2,373" id="srcline373">373</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,374" id="srcline374">374</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,375" id="srcline375">375</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,376" id="srcline376">376</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U2706">obj</span>.isTest11 == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,377" id="srcline377">377</a></span><span class="line">                <span class="var type0" id="S170T0U2711">s</span> = clamp(<span class="var type0" id="S111T0U2714">T</span>, 0, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,378" id="srcline378">378</a></span><span class="line">                <span class="var type0" id="S171T0U2719">ds</span> = max(1/<span class="var type0" id="S105T0U2725">obj</span>.t0_step,1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,379" id="srcline379">379</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,380" id="srcline380">380</a></span><span class="line">                <span class="var type0" id="S170T0U2731">s</span> = clamp(<span class="var type0" id="S105T0U2735">obj</span>.tauPhase,0,1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,381" id="srcline381">381</a></span><span class="line">                <span class="var type0" id="S171T0U2741">ds</span> = 1/<span class="var type0" id="S159T0U2745">t_step</span> + <span class="var type0" id="S169T0U2747">alpha_L</span>*(<span class="var type0" id="S105T0U2751">obj</span>.sDDA - <span class="var type0" id="S105T0U2754">obj</span>.tauPhase);</span></span>
<span class="srcline"><span class="lineno"><a href="2,382" id="srcline382">382</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,383" id="srcline383">383</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,384" id="srcline384">384</a></span><span class="line">            <span class="comment">% Compute Stance Leg Target Positions -------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,385" id="srcline385">385</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,386" id="srcline386">386</a></span><span class="line">            <span class="comment">% Compute Swing Leg Target Positions --------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,387" id="srcline387">387</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,388" id="srcline388">388</a></span><span class="line">            <span class="comment">% Target swing leg foot placement policy</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,389" id="srcline389">389</a></span><span class="line">            <span class="var type0" id="S172T0U2758">x_sw_tgt</span> = <span class="var type0" id="S105T0U2763">obj</span>.dx_gain*<span class="var type0" id="S105T0U2766">obj</span>.dx_est + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,390" id="srcline390">390</a></span><span class="line">                <span class="var type0" id="S105T0U2770">obj</span>.dx_err_p_gain*(<span class="var type0" id="S105T0U2775">obj</span>.dx_est - <span class="var type0" id="S105T0U2778">obj</span>.dx_tgt) + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,391" id="srcline391">391</a></span><span class="line">                <span class="var type0" id="S105T0U2782">obj</span>.dx_err_d_gain*(<span class="var type0" id="S105T0U2787">obj</span>.dx_est - <span class="var type0" id="S105T0U2790">obj</span>.dx_est_last);</span></span>
<span class="srcline"><span class="lineno"><a href="2,392" id="srcline392">392</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,393" id="srcline393">393</a></span><span class="line">            <span class="comment">%       x_sw_tgt = obj.dx_gain*obj.dx_est_05 + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,394" id="srcline394">394</a></span><span class="line">            <span class="comment">%         obj.dx_err_p_gain*(obj.dx_est_05 - obj.dx_tgt) + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,395" id="srcline395">395</a></span><span class="line">            <span class="comment">%         obj.dx_err_d_gain*(obj.dx_est_05 - obj.dx_est_05_last);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,396" id="srcline396">396</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,397" id="srcline397">397</a></span><span class="line">            <span class="comment">% Smooth clamp target swing leg foot placement</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,398" id="srcline398">398</a></span><span class="line">            <span class="var type0" id="S172T0U2794">x_sw_tgt</span> = atans(<span class="var type0" id="S172T0U2797">x_sw_tgt</span>, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,399" id="srcline399">399</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,400" id="srcline400">400</a></span><span class="line">            <span class="comment">% Target swing leg foot placement policy</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,401" id="srcline401">401</a></span><span class="line">            <span class="var type0" id="S174T0U2802">y_sw_tgt</span> = -<span class="var type0" id="S105T0U2809">obj</span>.stanceLeg*(<span class="var type0" id="S105T0U2814">obj</span>.y0_offset - <span class="var type0" id="S105T0U2818">obj</span>.y0_gain*abs(<span class="var type0" id="S105T0U2823">obj</span>.dx_est)) + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,402" id="srcline402">402</a></span><span class="line">                <span class="var type0" id="S105T0U2827">obj</span>.dy_gain*<span class="var type0" id="S105T0U2830">obj</span>.dy_est + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,403" id="srcline403">403</a></span><span class="line">                <span class="var type0" id="S105T0U2834">obj</span>.dy_err_p_gain*((<span class="var type0" id="S105T0U2842">obj</span>.dy_est + <span class="var type0" id="S105T0U2845">obj</span>.dy_est_last)/2 - <span class="var type0" id="S105T0U2849">obj</span>.dy_tgt) + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,404" id="srcline404">404</a></span><span class="line">                <span class="var type0" id="S105T0U2853">obj</span>.dy_err_d_gain*((<span class="var type0" id="S105T0U2861">obj</span>.dy_est + <span class="var type0" id="S105T0U2864">obj</span>.dy_est_last)/2 - <span class="var type0" id="S105T0U2868">obj</span>.dy_est_avg);</span></span>
<span class="srcline"><span class="lineno"><a href="2,405" id="srcline405">405</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,406" id="srcline406">406</a></span><span class="line">            <span class="comment">%             y_sw_tgt = -obj.stanceLeg*(obj.y0_offset - obj.y0_gain*abs(obj.dx_est)) + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,407" id="srcline407">407</a></span><span class="line">            <span class="comment">%                 obj.dy_err_p_gain*((obj.dy_est + obj.dy_est_last)/2 - obj.dy_tgt) + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,408" id="srcline408">408</a></span><span class="line">            <span class="comment">%                 obj.dy_err_d_gain*((obj.dy_est + obj.dy_est_last)/2 - obj.dy_est_avg);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,409" id="srcline409">409</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,410" id="srcline410">410</a></span><span class="line">            <span class="comment">%             y_sw_tgt = -obj.stanceLeg*(obj.y0_offset - obj.y0_gain*abs(obj.dx_est)) + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,411" id="srcline411">411</a></span><span class="line">            <span class="comment">%                 obj.dy_err_p_gain*(obj.dy_est - obj.dy_tgt) + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,412" id="srcline412">412</a></span><span class="line">            <span class="comment">%                 obj.dy_err_d_gain*(obj.dy_est - obj.dy_est_last);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,413" id="srcline413">413</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,414" id="srcline414">414</a></span><span class="line">            <span class="comment">% Smooth clamp target swing leg foot placement</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,415" id="srcline415">415</a></span><span class="line"><span class="comment">%           y_sw_tgt = atans(y_sw_tgt, 1, 0.5);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,416" id="srcline416">416</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,417" id="srcline417">417</a></span><span class="line">            <span class="comment">% Target swing leg cartesian position and velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,418" id="srcline418">418</a></span><span class="line">            <span class="var type0" id="S175T0U2872">y_sw</span> = <span class="var type0" id="S174T0U2873">y_sw_tgt</span>; <span class="var type0" id="S176T0U2876">dy_sw</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,419" id="srcline419">419</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,420" id="srcline420">420</a></span><span class="line">            <span class="comment">% Target swing hip angle and velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,421" id="srcline421">421</a></span><span class="line">            <span class="var type0" id="S177T0U2880">L</span> = sqrt(<span class="var type0" id="S105T0U2886">obj</span>.l0_leg^2 + <span class="var type0" id="S144T0U2890">l_sw_h</span>^2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,422" id="srcline422">422</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,423" id="srcline423">423</a></span><span class="line">            <span class="comment">%                   q_sw_h_tgt = real(asin((y_sw + y_t)/L) - asin(l_sw_h/L) - q_roll);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,424" id="srcline424">424</a></span><span class="line">            <span class="comment">%       dq_sw_h_tgt = real((dy_sw + dy_t)/(L *sqrt(1 - (y_sw + y_t)^2/L^2)) - dq_roll);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,425" id="srcline425">425</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,426" id="srcline426">426</a></span><span class="line">            <span class="var type0" id="S179T0U2894">q_sw_h_tgt</span> = real(asin(complex((<span class="var type0" id="S175T0U2905">y_sw</span> + <span class="var type0" id="S148T0U2906">y_t</span>)/<span class="var type0" id="S177T0U2907">L</span>)) - asin(complex(<span class="var type0" id="S144T0U2913">l_sw_h</span>/<span class="var type0" id="S177T0U2914">L</span>)));</span></span>
<span class="srcline"><span class="lineno"><a href="2,427" id="srcline427">427</a></span><span class="line">            <span class="var type0" id="S183T0U2917">dq_sw_h_tgt</span> = real((<span class="var type0" id="S176T0U2923">dy_sw</span> + <span class="var type0" id="S150T0U2924">dy_t</span>)/(<span class="var type0" id="S177T0U2927">L</span> *sqrt(1 - (<span class="var type0" id="S175T0U2936">y_sw</span> + <span class="var type0" id="S148T0U2937">y_t</span>)^2/<span class="var type0" id="S177T0U2940">L</span>^2)));</span></span>
<span class="srcline"><span class="lineno"><a href="2,428" id="srcline428">428</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,429" id="srcline429">429</a></span><span class="line">            <span class="comment">% Add position feedback</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,430" id="srcline430">430</a></span><span class="line">            <span class="comment">%             q_sw_h_tgt = q_sw_h_tgt - obj.dy_gain*q_st_h;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,431" id="srcline431">431</a></span><span class="line">            <span class="comment">%             dq_sw_h_tgt = dq_sw_h_tgt - obj.dy_gain*dq_st_h;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,432" id="srcline432">432</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,433" id="srcline433">433</a></span><span class="line">            <span class="comment">% Clamp swing hip angles to avoid mechanical limits</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,434" id="srcline434">434</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U2946">obj</span>.stanceLeg == -1</span></span>
<span class="srcline"><span class="lineno"><a href="2,435" id="srcline435">435</a></span><span class="line">                <span class="var type0" id="S179T0U2952">q_sw_h_tgt</span> = clamp(<span class="var type0" id="S179T0U2955">q_sw_h_tgt</span>, max(-10,-10+<span class="var type0" id="S121T0U2967">q_st_h</span>/pi*180)*pi/180, 10*pi/180);   <span class="comment">% for MARLO</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,436" id="srcline436">436</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,437" id="srcline437">437</a></span><span class="line">                <span class="var type0" id="S179T0U2983">q_sw_h_tgt</span> = clamp(<span class="var type0" id="S179T0U2986">q_sw_h_tgt</span>, min(10,10+<span class="var type0" id="S121T0U2996">q_st_h</span>/pi*180)*pi/180, -10*pi/180);   <span class="comment">% for MARLO</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,438" id="srcline438">438</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,439" id="srcline439">439</a></span><span class="line">            <span class="comment">% Compute Control Inputs -------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,440" id="srcline440">440</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,441" id="srcline441">441</a></span><span class="line">            <span class="comment">% Hip feed-forward torque for gravity compensation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,442" id="srcline442">442</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U3013">obj</span>.isSim</span></span>
<span class="srcline"><span class="lineno"><a href="2,443" id="srcline443">443</a></span><span class="line">                <span class="var type0" id="S185T0U3017">u_st_h</span> = <span class="var type0" id="S105T0U3021">obj</span>.m_leg*<span class="var type0" id="S105T0U3024">obj</span>.g*<span class="var type0" id="S143T0U3026">l_st_h</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,444" id="srcline444">444</a></span><span class="line">                <span class="var type0" id="S186T0U3029">u_sw_h</span> = <span class="var type0" id="S105T0U3033">obj</span>.m_leg*<span class="var type0" id="S105T0U3036">obj</span>.g*<span class="var type0" id="S144T0U3038">l_sw_h</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,445" id="srcline445">445</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,446" id="srcline446">446</a></span><span class="line">                <span class="var type0" id="S185T0U3042">u_st_h</span> = <span class="var type0" id="S105T0U3046">obj</span>.uHipGravity*26.7*<span class="var type0" id="S105T0U3050">obj</span>.stanceLeg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,447" id="srcline447">447</a></span><span class="line">                <span class="var type0" id="S186T0U3054">u_sw_h</span> = -<span class="var type0" id="S105T0U3059">obj</span>.uHipGravity*26.7*<span class="var type0" id="S105T0U3063">obj</span>.stanceLeg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,448" id="srcline448">448</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,449" id="srcline449">449</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,450" id="srcline450">450</a></span><span class="line">            <span class="comment">% Swing leg hip PD controller</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,451" id="srcline451">451</a></span><span class="line">            <span class="comment">% TODO: remove s scaling when trajectory is re-enabled</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,452" id="srcline452">452</a></span><span class="line">            <span class="comment">% Torso stabilization PD controller scaled based on leg force</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,453" id="srcline453">453</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,454" id="srcline454">454</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S108T0U3069">EnableTransition</span> == 0 || <span class="var type0" id="S105T0U3073">obj</span>.isTest5 == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,455" id="srcline455">455</a></span><span class="line">                <span class="var type0" id="S185T0U3078">u_st_h</span> = <span class="var type0" id="S105T0U3082">obj</span>.kp_hip*(2*pi/180*<span class="var type0" id="S105T0U3094">obj</span>.stanceLeg - <span class="var type0" id="S121T0U3096">q_st_h</span>) + <span class="var type0" id="S105T0U3099">obj</span>.kd_hip*(0 - <span class="var type0" id="S122T0U3104">dq_st_h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,456" id="srcline456">456</a></span><span class="line">                <span class="var type0" id="S186T0U3107">u_sw_h</span> = <span class="var type0" id="S105T0U3111">obj</span>.kp_hip*(-2*pi/180*<span class="var type0" id="S105T0U3124">obj</span>.stanceLeg - <span class="var type0" id="S131T0U3126">q_sw_h</span>) + <span class="var type0" id="S105T0U3129">obj</span>.kd_hip*(0 - <span class="var type0" id="S132T0U3134">dq_sw_h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,457" id="srcline457">457</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S105T0U3138">obj</span>.isTest7 == 1 <span class="comment">% Tracking</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,458" id="srcline458">458</a></span><span class="line">                <span class="var type0" id="S185T0U3143">u_st_h</span> = <span class="var type0" id="S185T0U3146">u_st_h</span> + <span class="var type0" id="S105T0U3149">obj</span>.kp_hip*((2+5*sin(2*pi*<span class="var type0" id="S170T0U3168">s</span>))*pi/180*<span class="var type0" id="S105T0U3173">obj</span>.stanceLeg - <span class="var type0" id="S121T0U3175">q_st_h</span>) + <span class="var type0" id="S105T0U3178">obj</span>.kd_hip*((5*cos(2*pi*<span class="var type0" id="S170T0U3198">s</span>))*2*pi*<span class="var type0" id="S171T0U3202">ds</span>*pi/180*<span class="var type0" id="S105T0U3207">obj</span>.stanceLeg - <span class="var type0" id="S122T0U3209">dq_st_h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,459" id="srcline459">459</a></span><span class="line">                <span class="var type0" id="S186T0U3212">u_sw_h</span> = <span class="var type0" id="S186T0U3215">u_sw_h</span> + <span class="var type0" id="S105T0U3218">obj</span>.kp_hip*(-(2+5*sin(2*pi*<span class="var type0" id="S170T0U3238">s</span>))*pi/180*<span class="var type0" id="S105T0U3243">obj</span>.stanceLeg - <span class="var type0" id="S131T0U3245">q_sw_h</span>) + <span class="var type0" id="S105T0U3248">obj</span>.kd_hip*(-(5*cos(2*pi*<span class="var type0" id="S170T0U3269">s</span>))*2*pi*<span class="var type0" id="S171T0U3273">ds</span>*pi/180*<span class="var type0" id="S105T0U3278">obj</span>.stanceLeg - <span class="var type0" id="S132T0U3280">dq_sw_h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,460" id="srcline460">460</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S105T0U3284">obj</span>.isTest8 == 1 <span class="comment">% Test hip gravity compensation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,461" id="srcline461">461</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,462" id="srcline462">462</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,463" id="srcline463">463</a></span><span class="line">                <span class="var type0" id="S186T0U3290">u_sw_h</span> = <span class="var type0" id="S186T0U3293">u_sw_h</span> + <span class="var type0" id="S170T0U3297">s</span>*(1 - <span class="var type0" id="S155T0U3301">s_sw</span>)*<span class="var type0" id="S105T0U3303">obj</span>.kp_hip*(<span class="var type0" id="S179T0U3307">q_sw_h_tgt</span> - <span class="var type0" id="S131T0U3308">q_sw_h</span>) + (1 - <span class="var type0" id="S155T0U3314">s_sw</span>)*<span class="var type0" id="S105T0U3316">obj</span>.kd_hip*(<span class="var type0" id="S183T0U3320">dq_sw_h_tgt</span> - <span class="var type0" id="S132T0U3321">dq_sw_h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,464" id="srcline464">464</a></span><span class="line">                <span class="var type0" id="S186T0U3324">u_sw_h</span> = <span class="var type0" id="S186T0U3326">u_sw_h</span> + <span class="var type0" id="S155T0U3328">s_sw</span>*(<span class="var type0" id="S105T0U3333">obj</span>.kp_hip*(<span class="var type0" id="S133T0U3337">q_roll</span> - 0) + <span class="var type0" id="S105T0U3341">obj</span>.kd_hip*(<span class="var type0" id="S134T0U3345">dq_roll</span> - 0));</span></span>
<span class="srcline"><span class="lineno"><a href="2,465" id="srcline465">465</a></span><span class="line">                <span class="var type0" id="S185T0U3349">u_st_h</span> = <span class="var type0" id="S185T0U3352">u_st_h</span> + <span class="var type0" id="S153T0U3354">s_st</span>*(<span class="var type0" id="S105T0U3359">obj</span>.kp_hip*(<span class="var type0" id="S133T0U3363">q_roll</span> - 0) + <span class="var type0" id="S105T0U3367">obj</span>.kd_hip*(<span class="var type0" id="S134T0U3371">dq_roll</span> - 0)) + (1 - <span class="var type0" id="S153T0U3378">s_st</span>)*<span class="var type0" id="S105T0U3380">obj</span>.kd_hip*(0 - <span class="var type0" id="S122T0U3385">dq_st_h</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,466" id="srcline466">466</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,467" id="srcline467">467</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,468" id="srcline468">468</a></span><span class="line">            <span class="comment">% DDA controller --------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,469" id="srcline469">469</a></span><span class="line">            <span class="var type0" id="S111T0U3388">T</span> = [1/2 1/2 0 0; 0 0 1/2 1/2; 1 -1 0 0; 0 0 1 -1];</span></span>
<span class="srcline"><span class="lineno"><a href="2,470" id="srcline470">470</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,471" id="srcline471">471</a></span><span class="line">            <span class="comment">% Swing leg position</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,472" id="srcline472">472</a></span><span class="line">            <span class="var type0" id="S187T0U3422">lsw</span> = cos((<span class="var type0" id="S123T0U3428">q_sw_mA</span> - <span class="var type0" id="S115T0U3429">q_st_mB</span>)/2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,473" id="srcline473">473</a></span><span class="line">            <span class="var type0" id="S188T0U3433">q_sw_tgt</span> = asin((clamp(<span class="var type0" id="S172T0U3440">x_sw_tgt</span>,-0.1,0.1))/<span class="var type0" id="S187T0U3444">lsw</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,474" id="srcline474">474</a></span><span class="line">            <span class="var type0" id="S189T0U3447">q_sw_offset</span> = asin((<span class="var type0" id="S145T0U3452">x_t</span>)/<span class="var type0" id="S187T0U3453">lsw</span>);   <span class="comment">% just feedforward</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,475" id="srcline475">475</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,476" id="srcline476">476</a></span><span class="line">            <span class="comment">% Define gait select input</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,477" id="srcline477">477</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U3458">obj</span>.isTest11 == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,478" id="srcline478">478</a></span><span class="line">                <span class="var type0" id="S162T0U3463">dxInput</span> = clamp(<span class="var type0" id="S105T0U3467">obj</span>.dx_tgt,-0.8,1.2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,479" id="srcline479">479</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,480" id="srcline480">480</a></span><span class="line">                <span class="var type0" id="S162T0U3475">dxInput</span> = clamp(<span class="var type0" id="S105T0U3479">obj</span>.dx_est,-0.8,1.2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,481" id="srcline481">481</a></span><span class="line">                <span class="comment">%                   dxInput = clamp(obj.dx_tgt,-0.8,0.8);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,482" id="srcline482">482</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,483" id="srcline483">483</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,484" id="srcline484">484</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U3488">obj</span>.stanceLeg == 1 <span class="comment">% Left</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,485" id="srcline485">485</a></span><span class="line">                <span class="var type0" id="S190T0U3493">hInput</span> = <span class="var type0" id="S105T0U3495">obj</span>.leftHeight;</span></span>
<span class="srcline"><span class="lineno"><a href="2,486" id="srcline486">486</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,487" id="srcline487">487</a></span><span class="line">                <span class="var type0" id="S190T0U3500">hInput</span> = <span class="var type0" id="S105T0U3502">obj</span>.rightHeight;</span></span>
<span class="srcline"><span class="lineno"><a href="2,488" id="srcline488">488</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,489" id="srcline489">489</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,490" id="srcline490">490</a></span><span class="line">            <span class="var type0" id="S191T0U3506">hEnd</span> = <span class="var type0" id="S105T0U3508">obj</span>.hBelieve;</span></span>
<span class="srcline"><span class="lineno"><a href="2,491" id="srcline491">491</a></span><span class="line">            <span class="keyword">if</span> (<span class="var type0" id="S142T0U3515">footHeight</span>&lt;=<span class="var type0" id="S191T0U3516">hEnd</span> &amp;&amp; <span class="var type0" id="S170T0U3518">s</span>&gt;0.6)</span></span>
<span class="srcline"><span class="lineno"><a href="2,492" id="srcline492">492</a></span><span class="line">                <span class="var type0" id="S191T0U3522">hEnd</span> = <span class="var type0" id="S142T0U3523">footHeight</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,493" id="srcline493">493</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,494" id="srcline494">494</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S170T0U3527">s</span>&gt;=1</span></span>
<span class="srcline"><span class="lineno"><a href="2,495" id="srcline495">495</a></span><span class="line">                <span class="var type0" id="S191T0U3531">hEnd</span> = <span class="var type0" id="S191T0U3533">hEnd</span> - 1*(<span class="var type0" id="S170T0U3538">s</span> - 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,496" id="srcline496">496</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,497" id="srcline497">497</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,498" id="srcline498">498</a></span><span class="line"><span class="comment">%           hInput = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,499" id="srcline499">499</a></span><span class="line"><span class="comment">%           hEnd = 0-0.01;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,500" id="srcline500">500</a></span><span class="line">            <span class="var type0" id="S190T0U3542">hInput</span> = clamp(<span class="var type0" id="S190T0U3545">hInput</span>,-0.1,0.1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,501" id="srcline501">501</a></span><span class="line">            <span class="var type0" id="S191T0U3551">hEnd</span> = clamp(<span class="var type0" id="S191T0U3554">hEnd</span>,-0.1,0.1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,502" id="srcline502">502</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,503" id="srcline503">503</a></span><span class="line">            <span class="comment">% Interpolate gaits</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,504" id="srcline504">504</a></span><span class="line">            <span class="var type0" id="S192T0U3560">HAlpha</span> = interpolateRoughGround(<span class="var type0" id="S110T0U3563">hAlphaSet</span>,<span class="var type0" id="S163T0U3564">dxSet</span>,<span class="var type0" id="S162T0U3565">dxInput</span>, <span class="var type0" id="S164T0U3566">hSet</span>, <span class="var type0" id="S190T0U3567">hInput</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,505" id="srcline505">505</a></span><span class="line">            <span class="var type0" id="S194T0U3570">HAlpha_norm</span> = interpolateRoughGround(<span class="var type0" id="S110T0U3573">hAlphaSet</span>,<span class="var type0" id="S163T0U3574">dxSet</span>,<span class="var type0" id="S162T0U3575">dxInput</span>, <span class="var type0" id="S164T0U3576">hSet</span>, <span class="var type0" id="S191T0U3577">hEnd</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,506" id="srcline506">506</a></span><span class="line">            <span class="var type0" id="S192T0U3581">HAlpha</span>(:,end-2:end) = <span class="var type0" id="S194T0U3591">HAlpha_norm</span>(:,end-2:end);</span></span>
<span class="srcline"><span class="lineno"><a href="2,507" id="srcline507">507</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,508" id="srcline508">508</a></span><span class="line">            <span class="var type0" id="S196T0U3602">q_pitch_leg</span> = <span class="var type0" id="S135T0U3605">q_pitch</span> + (<span class="var type0" id="S117T0U3609">q_st_lA</span> + <span class="var type0" id="S119T0U3610">q_st_lB</span>)/2 - (<span class="var type0" id="S113T0U3615">q_st_mA</span> + <span class="var type0" id="S115T0U3616">q_st_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,509" id="srcline509">509</a></span><span class="line">            <span class="comment">%            dq_pitch_leg = dq_pitch + (dq_st_lA + dq_st_lB)/2 - (dq_st_mA + dq_st_mB)/2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,510" id="srcline510">510</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U3622">obj</span>.isTest11 == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,511" id="srcline511">511</a></span><span class="line">                <span class="var type0" id="S192T0U3628">HAlpha</span>(2,:) = <span class="var type0" id="S192T0U3633">HAlpha</span>(2,:) + <span class="var type0" id="S189T0U3636">q_sw_offset</span>; <span class="comment">% feedback + offset, control the speed</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,512" id="srcline512">512</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,513" id="srcline513">513</a></span><span class="line">                <span class="var type0" id="S192T0U3641">HAlpha</span>(2,:) = <span class="var type0" id="S192T0U3647">HAlpha</span>(2,:) + <span class="var type0" id="S189T0U3650">q_sw_offset</span> + <span class="var type0" id="S196T0U3652">q_pitch_leg</span>*(1-<span class="var type0" id="S155T0U3656">s_sw</span>); <span class="comment">% feedback + offset, control the speed</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,514" id="srcline514">514</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,515" id="srcline515">515</a></span><span class="line">            <span class="var type0" id="S192T0U3660">HAlpha</span>(:,[1,2]) = [<span class="var type0" id="S105T0U3669">obj</span>.hd_last,<span class="var type0" id="S105T0U3675">obj</span>.dhd_last/5/<span class="var type0" id="S105T0U3679">obj</span>.ds_last+<span class="var type0" id="S105T0U3682">obj</span>.hd_last]; <span class="comment">% hybrid invariant</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,516" id="srcline516">516</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,517" id="srcline517">517</a></span><span class="line">            <span class="comment">% scratch ground yaw control</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,518" id="srcline518">518</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U3688">obj</span>.EnableYawControl == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,519" id="srcline519">519</a></span><span class="line">                <span class="keyword">if</span> <span class="var type0" id="S105T0U3695">obj</span>.stanceLeg == 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,520" id="srcline520">520</a></span><span class="line">                    <span class="comment">%                         HAlpha(2,4:5) = HAlpha(2,4:5) + clamp((obj.q_yaw_tgt-obj.q_yaw)*obj.kp_yaw+(0 - obj.dq_yaw_est)*obj.kd_yaw, -5*pi/180, 5*pi/180);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,521" id="srcline521">521</a></span><span class="line">                    <span class="var type0" id="S192T0U3701">HAlpha</span>(2,4:5) = <span class="var type0" id="S192T0U3708">HAlpha</span>(2,4:5) + clamp((<span class="var type0" id="S105T0U3718">obj</span>.dq_yaw_tgt)*<span class="var type0" id="S105T0U3721">obj</span>.kd_yaw, -5*pi/180, 5*pi/180);</span></span>
<span class="srcline"><span class="lineno"><a href="2,522" id="srcline522">522</a></span><span class="line">                <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,523" id="srcline523">523</a></span><span class="line">                    <span class="comment">%                         HAlpha(2,4:5) = HAlpha(2,4:5) - clamp((obj.q_yaw_tgt-obj.q_yaw)*obj.kp_yaw+(0 - obj.dq_yaw_est)*obj.kd_yaw, -5*pi/180, 5*pi/180);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,524" id="srcline524">524</a></span><span class="line">                    <span class="var type0" id="S192T0U3740">HAlpha</span>(2,4:5) = <span class="var type0" id="S192T0U3747">HAlpha</span>(2,4:5) - clamp((<span class="var type0" id="S105T0U3757">obj</span>.dq_yaw_tgt)*<span class="var type0" id="S105T0U3760">obj</span>.kd_yaw, -5*pi/180, 5*pi/180);</span></span>
<span class="srcline"><span class="lineno"><a href="2,525" id="srcline525">525</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,526" id="srcline526">526</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,527" id="srcline527">527</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,528" id="srcline528">528</a></span><span class="line">            <span class="comment">% Desired leg trajectory</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,529" id="srcline529">529</a></span><span class="line">            <span class="var type0" id="S197T0U3777">hd</span> = bezierval(<span class="var type0" id="S192T0U3780">HAlpha</span>,<span class="var type0" id="S170T0U3781">s</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,530" id="srcline530">530</a></span><span class="line">            <span class="var type0" id="S199T0U3784">dhd</span> = bezierval(diff(<span class="var type0" id="S192T0U3791">HAlpha</span>,[],2),<span class="var type0" id="S170T0U3795">s</span>)*5*<span class="var type0" id="S171T0U3797">ds</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,531" id="srcline531">531</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,532" id="srcline532">532</a></span><span class="line">            <span class="comment">% Double Support Hack</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,533" id="srcline533">533</a></span><span class="line">            <span class="keyword">if</span> 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,534" id="srcline534">534</a></span><span class="line">                doubleRate = 0.2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,535" id="srcline535">535</a></span><span class="line">                s_swKnee = 0*(s&lt;doubleRate)+(s-doubleRate)*(1/(1-doubleRate))*(s&gt;=doubleRate);</span></span>
<span class="srcline"><span class="lineno"><a href="2,536" id="srcline536">536</a></span><span class="line">                ds_swKnee = 0*(s&lt;doubleRate)+ds*(1/(1-doubleRate))*(s&gt;=doubleRate);</span></span>
<span class="srcline"><span class="lineno"><a href="2,537" id="srcline537">537</a></span><span class="line">                hd_swKnee = bezierval(HAlpha,s_swKnee);</span></span>
<span class="srcline"><span class="lineno"><a href="2,538" id="srcline538">538</a></span><span class="line">                dhd_swKnee = bezierval(diff(HAlpha,[],2),s_swKnee)*5*ds_swKnee;</span></span>
<span class="srcline"><span class="lineno"><a href="2,539" id="srcline539">539</a></span><span class="line">                hd(4) = hd_swKnee(4);</span></span>
<span class="srcline"><span class="lineno"><a href="2,540" id="srcline540">540</a></span><span class="line">                dhd(4) = dhd_swKnee(4);</span></span>
<span class="srcline"><span class="lineno"><a href="2,541" id="srcline541">541</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,542" id="srcline542">542</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,543" id="srcline543">543</a></span><span class="line">            <span class="comment">% Swing leg placement</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,544" id="srcline544">544</a></span><span class="line">            <span class="var type0" id="S201T0U3897">HAlphaNon</span> = [0 0 1 1 1 1];</span></span>
<span class="srcline"><span class="lineno"><a href="2,545" id="srcline545">545</a></span><span class="line">            <span class="var type0" id="S202T0U3908">hd2</span> = bezierval(<span class="var type0" id="S201T0U3912">HAlphaNon</span>,<span class="var type0" id="S170T0U3913">s</span>)*<span class="var type0" id="S188T0U3914">q_sw_tgt</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,546" id="srcline546">546</a></span><span class="line">            <span class="var type0" id="S203T0U3917">dhd2</span> = bezierval(diff(<span class="var type0" id="S201T0U3925">HAlphaNon</span>,[],2),<span class="var type0" id="S170T0U3929">s</span>)*5*<span class="var type0" id="S171T0U3931">ds</span>*<span class="var type0" id="S188T0U3932">q_sw_tgt</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,547" id="srcline547">547</a></span><span class="line">            <span class="var type0" id="S197T0U3936">hd</span>(2) = <span class="var type0" id="S197T0U3940">hd</span>(2) + <span class="var type0" id="S202T0U3942">hd2</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,548" id="srcline548">548</a></span><span class="line">            <span class="var type0" id="S199T0U3946">dhd</span>(2) = <span class="var type0" id="S199T0U3950">dhd</span>(2) + <span class="var type0" id="S203T0U3952">dhd2</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,549" id="srcline549">549</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,550" id="srcline550">550</a></span><span class="line">            <span class="comment">% Constant leg</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,551" id="srcline551">551</a></span><span class="line">            <span class="keyword">if</span> 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,552" id="srcline552">552</a></span><span class="line">                hd = [160;200;30;30]*pi/180;</span></span>
<span class="srcline"><span class="lineno"><a href="2,553" id="srcline553">553</a></span><span class="line">                dhd = zeros(4,1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,554" id="srcline554">554</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,555" id="srcline555">555</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,556" id="srcline556">556</a></span><span class="line">            <span class="comment">% Torso control override</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,557" id="srcline557">557</a></span><span class="line">            <span class="var type0" id="S197T0U3982">hd</span>(1) = 2*pi - (<span class="var type0" id="S113T0U3992">q_st_mA</span>+<span class="var type0" id="S115T0U3993">q_st_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,558" id="srcline558">558</a></span><span class="line">            <span class="var type0" id="S199T0U3998">dhd</span>(1) = - (<span class="var type0" id="S114T0U4004">dq_st_mA</span>+<span class="var type0" id="S116T0U4005">dq_st_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,559" id="srcline559">559</a></span><span class="line">            <span class="var type0" id="S197T0U4010">hd</span>(1) = <span class="var type0" id="S197T0U4015">hd</span>(1)*(1-<span class="var type0" id="S153T0U4020">s_st</span>) + (2*pi - mean([<span class="var type0" id="S117T0U4033">q_st_lA</span> <span class="var type0" id="S119T0U4034">q_st_lB</span>]) - <span class="var type0" id="S135T0U4035">q_pitch</span>)*<span class="var type0" id="S153T0U4036">s_st</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,560" id="srcline560">560</a></span><span class="line">            <span class="var type0" id="S199T0U4040">dhd</span>(1) = <span class="var type0" id="S199T0U4045">dhd</span>(1)*(1-<span class="var type0" id="S153T0U4050">s_st</span>) + ( - mean([<span class="var type0" id="S118T0U4059">dq_st_lA</span> <span class="var type0" id="S120T0U4060">dq_st_lB</span>]) - <span class="var type0" id="S136T0U4061">dq_pitch</span>)*<span class="var type0" id="S153T0U4062">s_st</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,561" id="srcline561">561</a></span><span class="line">            <span class="var type0" id="S197T0U4066">hd</span>(2) = <span class="var type0" id="S197T0U4071">hd</span>(2)*(1-<span class="var type0" id="S155T0U4076">s_sw</span>) + (2*pi - mean([<span class="var type0" id="S127T0U4089">q_sw_lA</span> <span class="var type0" id="S129T0U4090">q_sw_lB</span>]) - <span class="var type0" id="S135T0U4091">q_pitch</span>)*<span class="var type0" id="S155T0U4092">s_sw</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,562" id="srcline562">562</a></span><span class="line">            <span class="var type0" id="S199T0U4096">dhd</span>(2) = <span class="var type0" id="S199T0U4101">dhd</span>(2)*(1-<span class="var type0" id="S155T0U4106">s_sw</span>) + ( - mean([<span class="var type0" id="S128T0U4115">dq_sw_lA</span> <span class="var type0" id="S130T0U4116">dq_sw_lB</span>]) - <span class="var type0" id="S136T0U4117">dq_pitch</span>)*<span class="var type0" id="S155T0U4118">s_sw</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,563" id="srcline563">563</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,564" id="srcline564">564</a></span><span class="line">            <span class="comment">% Virtual knee damping</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,565" id="srcline565">565</a></span><span class="line">            <span class="var type0" id="S205T0U4121">vKneeSpring</span> = [(<span class="var type0" id="S120T0U4127">dq_st_lB</span> - <span class="var type0" id="S118T0U4128">dq_st_lA</span>) - (<span class="var type0" id="S116T0U4131">dq_st_mB</span> - <span class="var type0" id="S114T0U4132">dq_st_mA</span>);(<span class="var type0" id="S130T0U4137">dq_sw_lB</span> - <span class="var type0" id="S128T0U4138">dq_sw_lA</span>) - (<span class="var type0" id="S126T0U4141">dq_sw_mB</span> - <span class="var type0" id="S124T0U4142">dq_sw_mA</span>)];</span></span>
<span class="srcline"><span class="lineno"><a href="2,566" id="srcline566">566</a></span><span class="line">            <span class="var type0" id="S206T0U4145">uKneeSpring</span> = <span class="var type0" id="S105T0U4148">obj</span>.kd_vs*<span class="var type0" id="S205T0U4150">vKneeSpring</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,567" id="srcline567">567</a></span><span class="line">            <span class="var type0" id="S207T0U4153">uLegSpring</span> = [0;0];</span></span>
<span class="srcline"><span class="lineno"><a href="2,568" id="srcline568">568</a></span><span class="line">            <span class="var type0" id="S208T0U4161">uDamping</span> = <span class="var type0" id="S111T0U4163">T</span>\[<span class="var type0" id="S207T0U4166">uLegSpring</span>;-<span class="var type0" id="S206T0U4169">uKneeSpring</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="2,569" id="srcline569">569</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,570" id="srcline570">570</a></span><span class="line">            <span class="comment">% Convert to link coordinate</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,571" id="srcline571">571</a></span><span class="line">            <span class="var type0" id="S209T0U4172">hd_q</span> = 2*pi - <span class="var type0" id="S111T0U4179">T</span>\<span class="var type0" id="S197T0U4180">hd</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,572" id="srcline572">572</a></span><span class="line">            <span class="var type0" id="S210T0U4183">dhd_q</span> = -<span class="var type0" id="S111T0U4186">T</span>\<span class="var type0" id="S199T0U4187">dhd</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,573" id="srcline573">573</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,574" id="srcline574">574</a></span><span class="line">            <span class="comment">% Set leg to constant</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,575" id="srcline575">575</a></span><span class="line">            <span class="keyword">if</span> 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,576" id="srcline576">576</a></span><span class="line">                hd_q = [160;200;160;200]*pi/180;</span></span>
<span class="srcline"><span class="lineno"><a href="2,577" id="srcline577">577</a></span><span class="line">                dhd_q = zeros(4,1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,578" id="srcline578">578</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,579" id="srcline579">579</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,580" id="srcline580">580</a></span><span class="line">            <span class="comment">% BMI output chosen</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,581" id="srcline581">581</a></span><span class="line">            <span class="var type0" id="S211T0U4216">H</span> = [zeros(4,3) eye(4) zeros(4,2)];</span></span>
<span class="srcline"><span class="lineno"><a href="2,582" id="srcline582">582</a></span><span class="line">            <span class="var type0" id="S211T0U4233">H</span>(3,end-1) = -1/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,583" id="srcline583">583</a></span><span class="line">            <span class="var type0" id="S211T0U4246">H</span>(4,end-1) = 1/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,584" id="srcline584">584</a></span><span class="line">            <span class="var type0" id="S211T0U4258">H</span>(3,end) = -1/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,585" id="srcline585">585</a></span><span class="line">            <span class="var type0" id="S211T0U4269">H</span>(4,end) = 1/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,586" id="srcline586">586</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,587" id="srcline587">587</a></span><span class="line">            <span class="var type0" id="S214T0U4278">q_d</span> = [<span class="var type0" id="S133T0U4281">q_roll</span>;<span class="var type0" id="S105T0U4284">obj</span>.q_yaw;<span class="var type0" id="S135T0U4287">q_pitch</span>;<span class="var type0" id="S209T0U4289">hd_q</span>;0;0];</span></span>
<span class="srcline"><span class="lineno"><a href="2,588" id="srcline588">588</a></span><span class="line">            <span class="var type0" id="S215T0U4296">q_0</span> = [<span class="var type0" id="S133T0U4299">q_roll</span>;<span class="var type0" id="S105T0U4302">obj</span>.q_yaw;<span class="var type0" id="S135T0U4305">q_pitch</span>;[<span class="var type0" id="S113T0U4309">q_st_mA</span>;<span class="var type0" id="S115T0U4311">q_st_mB</span>;<span class="var type0" id="S123T0U4313">q_sw_mA</span>;<span class="var type0" id="S125T0U4315">q_sw_mB</span>];0;0];</span></span>
<span class="srcline"><span class="lineno"><a href="2,589" id="srcline589">589</a></span><span class="line">            <span class="var type0" id="S216T0U4322">dq_d</span> = [<span class="var type0" id="S134T0U4325">dq_roll</span>;<span class="var type0" id="S105T0U4328">obj</span>.dq_yaw;<span class="var type0" id="S136T0U4331">dq_pitch</span>;<span class="var type0" id="S210T0U4333">dhd_q</span>;abs(<span class="var type0" id="S105T0U4339">obj</span>.dx_tgt)*<span class="var type0" id="S170T0U4341">s</span>;0];</span></span>
<span class="srcline"><span class="lineno"><a href="2,590" id="srcline590">590</a></span><span class="line">            <span class="var type0" id="S217T0U4346">dq_0</span> = [<span class="var type0" id="S134T0U4349">dq_roll</span>;<span class="var type0" id="S105T0U4352">obj</span>.dq_yaw;<span class="var type0" id="S136T0U4355">dq_pitch</span>;[<span class="var type0" id="S114T0U4359">dq_st_mA</span>;<span class="var type0" id="S116T0U4361">dq_st_mB</span>;<span class="var type0" id="S124T0U4363">dq_sw_mA</span>;<span class="var type0" id="S126T0U4365">dq_sw_mB</span>];abs(<span class="var type0" id="S105T0U4371">obj</span>.dx_est)*<span class="var type0" id="S170T0U4373">s</span>;abs((<span class="var type0" id="S105T0U4382">obj</span>.dy_est + <span class="var type0" id="S105T0U4385">obj</span>.dy_est_last)/2)*<span class="var type0" id="S170T0U4388">s</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="2,591" id="srcline591">591</a></span><span class="line">            <span class="var type0" id="S218T0U4391">delta_q</span> = <span class="var type0" id="S211T0U4393">H</span>*(<span class="var type0" id="S214T0U4396">q_d</span> - <span class="var type0" id="S215T0U4397">q_0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,592" id="srcline592">592</a></span><span class="line">            <span class="var type0" id="S219T0U4400">delta_dq</span> = <span class="var type0" id="S211T0U4402">H</span>*(<span class="var type0" id="S216T0U4405">dq_d</span> - <span class="var type0" id="S217T0U4406">dq_0</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,593" id="srcline593">593</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,594" id="srcline594">594</a></span><span class="line">            <span class="comment">% Torque output</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,595" id="srcline595">595</a></span><span class="line">            <span class="var type0" id="S220T0U4409">n</span> = <span class="var type0" id="S105T0U4411">obj</span>.kp_vs;</span></span>
<span class="srcline"><span class="lineno"><a href="2,596" id="srcline596">596</a></span><span class="line"><span class="comment">%           kp_st = s_st*obj.kp_st_leg*(s+n)/(1+n) + (1-s_st)*obj.kp_sw_leg;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,597" id="srcline597">597</a></span><span class="line"><span class="comment">%           kd_st = s_st*obj.kd_st_leg*(s+n)/(1+n) + (1-s_st)*obj.kd_sw_leg;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,598" id="srcline598">598</a></span><span class="line"><span class="comment">%           kp_sw = s_sw*obj.kp_st_leg*(s+n)/(1+n) + (1-s_sw)*obj.kp_sw_leg;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,599" id="srcline599">599</a></span><span class="line"><span class="comment">%           kd_sw = s_sw*obj.kd_st_leg*(s+n)/(1+n) + (1-s_sw)*obj.kd_sw_leg;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,600" id="srcline600">600</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,601" id="srcline601">601</a></span><span class="line">            <span class="var type0" id="S221T0U4415">kp_st</span> = <span class="var type0" id="S153T0U4418">s_st</span>*<span class="var type0" id="S105T0U4420">obj</span>.kp_st_leg + (1-<span class="var type0" id="S153T0U4426">s_st</span>)*<span class="var type0" id="S105T0U4428">obj</span>.kp_sw_leg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,602" id="srcline602">602</a></span><span class="line">            <span class="var type0" id="S222T0U4432">kd_st</span> = <span class="var type0" id="S153T0U4435">s_st</span>*<span class="var type0" id="S105T0U4437">obj</span>.kd_st_leg + (1-<span class="var type0" id="S153T0U4443">s_st</span>)*<span class="var type0" id="S105T0U4445">obj</span>.kd_sw_leg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,603" id="srcline603">603</a></span><span class="line">            <span class="var type0" id="S223T0U4449">kp_sw</span> = <span class="var type0" id="S155T0U4452">s_sw</span>*<span class="var type0" id="S105T0U4454">obj</span>.kp_st_leg + (1-<span class="var type0" id="S155T0U4460">s_sw</span>)*<span class="var type0" id="S105T0U4462">obj</span>.kp_sw_leg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,604" id="srcline604">604</a></span><span class="line">            <span class="var type0" id="S224T0U4466">kd_sw</span> = <span class="var type0" id="S155T0U4469">s_sw</span>*<span class="var type0" id="S105T0U4471">obj</span>.kd_st_leg + (1-<span class="var type0" id="S155T0U4477">s_sw</span>)*<span class="var type0" id="S105T0U4479">obj</span>.kd_sw_leg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,605" id="srcline605">605</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,606" id="srcline606">606</a></span><span class="line"><span class="comment">%           u_Link = [kp_st;kp_st;kp_sw;kp_sw].*(hd_q - [q_st_mA;q_st_mB;q_sw_mA;q_sw_mB]) + <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,607" id="srcline607">607</a></span><span class="line"><span class="comment">%               [kd_st;kd_st;kd_sw;kd_sw].*(dhd_q - [dq_st_mA;dq_st_mB;dq_sw_mA;dq_sw_mB]) +<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,608" id="srcline608">608</a></span><span class="line"><span class="comment">%               uDamping;</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,609" id="srcline609">609</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,610" id="srcline610">610</a></span><span class="line">            <span class="var type0" id="S225T0U4483">u_Link</span> = [<span class="var type0" id="S221T0U4489">kp_st</span>;<span class="var type0" id="S221T0U4491">kp_st</span>;<span class="var type0" id="S223T0U4493">kp_sw</span>;<span class="var type0" id="S223T0U4495">kp_sw</span>].*<span class="var type0" id="S218T0U4496">delta_q</span> + <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,611" id="srcline611">611</a></span><span class="line">                [<span class="var type0" id="S222T0U4500">kd_st</span>;<span class="var type0" id="S222T0U4502">kd_st</span>;<span class="var type0" id="S224T0U4504">kd_sw</span>;<span class="var type0" id="S224T0U4506">kd_sw</span>].*<span class="var type0" id="S219T0U4507">delta_dq</span> +<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,612" id="srcline612">612</a></span><span class="line">                <span class="var type0" id="S208T0U4508">uDamping</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,613" id="srcline613">613</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,614" id="srcline614">614</a></span><span class="line">            <span class="var type0" id="S226T0U4511">u_st_A</span> = <span class="var type0" id="S225T0U4513">u_Link</span>(1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,615" id="srcline615">615</a></span><span class="line">            <span class="var type0" id="S227T0U4517">u_st_B</span> = <span class="var type0" id="S225T0U4519">u_Link</span>(2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,616" id="srcline616">616</a></span><span class="line">            <span class="var type0" id="S228T0U4523">u_sw_A</span> = <span class="var type0" id="S225T0U4525">u_Link</span>(3);</span></span>
<span class="srcline"><span class="lineno"><a href="2,617" id="srcline617">617</a></span><span class="line">            <span class="var type0" id="S229T0U4529">u_sw_B</span> = <span class="var type0" id="S225T0U4531">u_Link</span>(4);</span></span>
<span class="srcline"><span class="lineno"><a href="2,618" id="srcline618">618</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,619" id="srcline619">619</a></span><span class="line">            <span class="comment">%           u_st_A = kp_st*(hd_q(1)-q_st_mA) + kd_st*(dhd_q(1)-dq_st_mA)+uDamping(1);% + obj.kd_vs*(dq_st_lA - dq_st_mA);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,620" id="srcline620">620</a></span><span class="line">            <span class="comment">%           u_st_B = kp_st*(hd_q(2)-q_st_mB) + kd_st*(dhd_q(2)-dq_st_mB)+uDamping(2);% + obj.kd_vs*(dq_st_lB - dq_st_mB);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,621" id="srcline621">621</a></span><span class="line">            <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,622" id="srcline622">622</a></span><span class="line">            <span class="comment">%           u_sw_A = kp_sw*(hd_q(3)-q_sw_mA) + kd_sw*(dhd_q(3)-dq_sw_mA)+uDamping(3);% + obj.kd_vs*(dq_sw_lA - dq_sw_mA);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,623" id="srcline623">623</a></span><span class="line">            <span class="comment">%           u_sw_B = kp_sw*(hd_q(4)-q_sw_mB) + kd_sw*(dhd_q(4)-dq_sw_mB)+uDamping(4);% + obj.kd_vs*(dq_sw_lB - dq_sw_mB);</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,624" id="srcline624">624</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,625" id="srcline625">625</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,626" id="srcline626">626</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,627" id="srcline627">627</a></span><span class="line">            <span class="comment">% QP decision for saturation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,628" id="srcline628">628</a></span><span class="line">            <span class="var type0" id="S230T0U4535">w</span> = 10.^(scaleFactor(<span class="var type0" id="S170T0U4543">s</span>, 0.3, 0.7)*2 - 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,629" id="srcline629">629</a></span><span class="line">            [<span class="var type0" id="S231T0U4551">u_opt</span>,~,~]= LA_LS_Revised_Saturation(<span class="var type0" id="S228T0U4557">u_sw_A</span>-<span class="var type0" id="S229T0U4558">u_sw_B</span>,(<span class="var type0" id="S228T0U4562">u_sw_A</span>+<span class="var type0" id="S229T0U4563">u_sw_B</span>)/2,<span class="var type0" id="S230T0U4565">w</span>,-<span class="var type0" id="S105T0U4568">obj</span>.u_lim,<span class="var type0" id="S105T0U4571">obj</span>.u_lim,-<span class="var type0" id="S105T0U4575">obj</span>.u_lim,<span class="var type0" id="S105T0U4578">obj</span>.u_lim);</span></span>
<span class="srcline"><span class="lineno"><a href="2,630" id="srcline630">630</a></span><span class="line">            <span class="var type0" id="S228T0U4582">u_sw_A</span> = <span class="var type0" id="S231T0U4584">u_opt</span>(2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,631" id="srcline631">631</a></span><span class="line">            <span class="var type0" id="S229T0U4588">u_sw_B</span> = <span class="var type0" id="S231T0U4590">u_opt</span>(1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,632" id="srcline632">632</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,633" id="srcline633">633</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,634" id="srcline634">634</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,635" id="srcline635">635</a></span><span class="line">            <span class="comment">% Compute actual leg states</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,636" id="srcline636">636</a></span><span class="line">            <span class="var type0" id="S233T0U4594">l_st_m</span> = cos((<span class="var type0" id="S113T0U4600">q_st_mA</span> - <span class="var type0" id="S115T0U4601">q_st_mB</span>)/2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,637" id="srcline637">637</a></span><span class="line">            <span class="var type0" id="S234T0U4605">dl_st_m</span> = -(sin((<span class="var type0" id="S113T0U4615">q_st_mA</span> - <span class="var type0" id="S115T0U4616">q_st_mB</span>)/2).*(<span class="var type0" id="S114T0U4620">dq_st_mA</span> - <span class="var type0" id="S116T0U4621">dq_st_mB</span>))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,638" id="srcline638">638</a></span><span class="line">            <span class="var type0" id="S235T0U4625">l_st_l</span> = cos((<span class="var type0" id="S117T0U4631">q_st_lA</span> - <span class="var type0" id="S119T0U4632">q_st_lB</span>)/2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,639" id="srcline639">639</a></span><span class="line">            <span class="var type0" id="S236T0U4636">dl_st_l</span> = -(sin((<span class="var type0" id="S117T0U4646">q_st_lA</span> - <span class="var type0" id="S119T0U4647">q_st_lB</span>)/2).*(<span class="var type0" id="S118T0U4651">dq_st_lA</span> - <span class="var type0" id="S120T0U4652">dq_st_lB</span>))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,640" id="srcline640">640</a></span><span class="line">            <span class="var type0" id="S237T0U4656">q_st_m</span> = (<span class="var type0" id="S113T0U4660">q_st_mA</span> + <span class="var type0" id="S115T0U4661">q_st_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,641" id="srcline641">641</a></span><span class="line">            <span class="var type0" id="S238T0U4665">dq_st_m</span> = (<span class="var type0" id="S114T0U4669">dq_st_mA</span> + <span class="var type0" id="S116T0U4670">dq_st_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,642" id="srcline642">642</a></span><span class="line">            <span class="var type0" id="S239T0U4674">q_st_l</span> = (<span class="var type0" id="S117T0U4678">q_st_lA</span> + <span class="var type0" id="S119T0U4679">q_st_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,643" id="srcline643">643</a></span><span class="line">            <span class="var type0" id="S240T0U4683">dq_st_l</span> = (<span class="var type0" id="S118T0U4687">dq_st_lA</span> + <span class="var type0" id="S120T0U4688">dq_st_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,644" id="srcline644">644</a></span><span class="line">            <span class="var type0" id="S241T0U4692">l_sw_m</span> = cos((<span class="var type0" id="S123T0U4698">q_sw_mA</span> - <span class="var type0" id="S125T0U4699">q_sw_mB</span>)/2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,645" id="srcline645">645</a></span><span class="line">            <span class="var type0" id="S242T0U4703">dl_sw_m</span> = -(sin((<span class="var type0" id="S123T0U4713">q_sw_mA</span> - <span class="var type0" id="S125T0U4714">q_sw_mB</span>)/2).*(<span class="var type0" id="S124T0U4718">dq_sw_mA</span> - <span class="var type0" id="S126T0U4719">dq_sw_mB</span>))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,646" id="srcline646">646</a></span><span class="line">            <span class="var type0" id="S243T0U4723">l_sw_l</span> = cos((<span class="var type0" id="S127T0U4729">q_sw_lA</span> - <span class="var type0" id="S129T0U4730">q_sw_lB</span>)/2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,647" id="srcline647">647</a></span><span class="line">            <span class="var type0" id="S244T0U4734">dl_sw_l</span> = -(sin((<span class="var type0" id="S127T0U4744">q_sw_lA</span> - <span class="var type0" id="S129T0U4745">q_sw_lB</span>)/2).*(<span class="var type0" id="S128T0U4749">dq_sw_lA</span> - <span class="var type0" id="S130T0U4750">dq_sw_lB</span>))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,648" id="srcline648">648</a></span><span class="line">            <span class="var type0" id="S245T0U4754">q_sw_m</span> = (<span class="var type0" id="S123T0U4758">q_sw_mA</span> + <span class="var type0" id="S125T0U4759">q_sw_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,649" id="srcline649">649</a></span><span class="line">            <span class="var type0" id="S246T0U4763">dq_sw_m</span> = (<span class="var type0" id="S124T0U4767">dq_sw_mA</span> + <span class="var type0" id="S126T0U4768">dq_sw_mB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,650" id="srcline650">650</a></span><span class="line">            <span class="var type0" id="S247T0U4772">q_sw_l</span> = (<span class="var type0" id="S127T0U4776">q_sw_lA</span> + <span class="var type0" id="S129T0U4777">q_sw_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,651" id="srcline651">651</a></span><span class="line">            <span class="var type0" id="S248T0U4781">dq_sw_l</span> = (<span class="var type0" id="S128T0U4785">dq_sw_lA</span> + <span class="var type0" id="S130T0U4786">dq_sw_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,652" id="srcline652">652</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,653" id="srcline653">653</a></span><span class="line">            <span class="comment">% Store signals in object for logging</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,654" id="srcline654">654</a></span><span class="line">            <span class="var type0" id="S105T0U4791">obj</span>.output = [<span class="var type0" id="S190T0U4795">hInput</span>;<span class="var type0" id="S191T0U4797">hEnd</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="2,655" id="srcline655">655</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,656" id="srcline656">656</a></span><span class="line">            <span class="comment">% Set commanded torque vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,657" id="srcline657">657</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S105T0U4802">obj</span>.stanceLeg == 1 <span class="comment">% Left</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,658" id="srcline658">658</a></span><span class="line">                <span class="var type0" id="S102T0U4807">u</span> = [<span class="var type0" id="S105T0U4812">obj</span>.s_r_B*<span class="var type0" id="S229T0U4814">u_sw_B</span>, <span class="var type0" id="S105T0U4817">obj</span>.s_r_A*<span class="var type0" id="S228T0U4819">u_sw_A</span>, <span class="var type0" id="S186T0U4820">u_sw_h</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,659" id="srcline659">659</a></span><span class="line">                    <span class="var type0" id="S105T0U4823">obj</span>.s_l_B*<span class="var type0" id="S227T0U4825">u_st_B</span>, <span class="var type0" id="S105T0U4828">obj</span>.s_l_A*<span class="var type0" id="S226T0U4830">u_st_A</span>, <span class="var type0" id="S185T0U4831">u_st_h</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="2,660" id="srcline660">660</a></span><span class="line">            <span class="keyword">else</span> <span class="comment">% Right</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,661" id="srcline661">661</a></span><span class="line">                <span class="var type0" id="S102T0U4835">u</span> = [<span class="var type0" id="S105T0U4840">obj</span>.s_l_B*<span class="var type0" id="S227T0U4842">u_st_B</span>, <span class="var type0" id="S105T0U4845">obj</span>.s_l_A*<span class="var type0" id="S226T0U4847">u_st_A</span>, <span class="var type0" id="S185T0U4848">u_st_h</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,662" id="srcline662">662</a></span><span class="line">                    <span class="var type0" id="S105T0U4851">obj</span>.s_r_B*<span class="var type0" id="S229T0U4853">u_sw_B</span>, <span class="var type0" id="S105T0U4856">obj</span>.s_r_A*<span class="var type0" id="S228T0U4858">u_sw_A</span>, <span class="var type0" id="S186T0U4859">u_sw_h</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="2,663" id="srcline663">663</a></span><span class="line">            <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,664" id="srcline664">664</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,665" id="srcline665">665</a></span><span class="line">            <span class="comment">% Output</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,666" id="srcline666">666</a></span><span class="line">            <span class="var type0" id="S103T0U4862">y_out</span> = [<span class="var type0" id="S209T0U4867">hd_q</span>(1)-<span class="var type0" id="S113T0U4869">q_st_mA</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,667" id="srcline667">667</a></span><span class="line">                <span class="var type0" id="S209T0U4873">hd_q</span>(2)-<span class="var type0" id="S115T0U4875">q_st_mB</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,668" id="srcline668">668</a></span><span class="line">                <span class="var type0" id="S209T0U4879">hd_q</span>(3)-<span class="var type0" id="S123T0U4881">q_sw_mA</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,669" id="srcline669">669</a></span><span class="line">                <span class="var type0" id="S209T0U4885">hd_q</span>(4)-<span class="var type0" id="S125T0U4887">q_sw_mB</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,670" id="srcline670">670</a></span><span class="line">                <span class="var type0" id="S209T0U4891">hd_q</span>(4)/10;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,671" id="srcline671">671</a></span><span class="line">                <span class="var type0" id="S125T0U4896">q_sw_mB</span>/10];</span></span>
<span class="srcline"><span class="lineno"><a href="2,672" id="srcline672">672</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,673" id="srcline673">673</a></span><span class="line">            <span class="var type0" id="S104T0U4900">dy_out</span> = [ (2+5*sin(2*pi*<span class="var type0" id="S170T0U4919">s</span>))*pi/180*<span class="var type0" id="S105T0U4924">obj</span>.stanceLeg - <span class="var type0" id="S121T0U4926">q_st_h</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,674" id="srcline674">674</a></span><span class="line">                -(2+5*sin(2*pi*<span class="var type0" id="S170T0U4945">s</span>))*pi/180*<span class="var type0" id="S105T0U4950">obj</span>.stanceLeg - <span class="var type0" id="S131T0U4952">q_sw_h</span>;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,675" id="srcline675">675</a></span><span class="line">                0;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,676" id="srcline676">676</a></span><span class="line">                0;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,677" id="srcline677">677</a></span><span class="line">                <span class="var type0" id="S153T0U4960">s_st</span>/180*pi;<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,678" id="srcline678">678</a></span><span class="line">                <span class="var type0" id="S155T0U4967">s_sw</span>/180*pi];</span></span>
<span class="srcline"><span class="lineno"><a href="2,679" id="srcline679">679</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,680" id="srcline680">680</a></span><span class="line">            <span class="comment">% Reset guard -----------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,681" id="srcline681">681</a></span><span class="line">            <span class="comment">%       if s &gt;= 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,682" id="srcline682">682</a></span><span class="line">            <span class="comment">%       if (((s &gt;= 0.5 &amp;&amp; s_sw &gt;= 1)  || (s &gt;= 1)) &amp;&amp; obj.isTest11 == 0) || (s &gt;= 1 &amp;&amp; obj.isTest11 == 1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,683" id="srcline683">683</a></span><span class="line">            <span class="keyword">if</span> (((<span class="var type0" id="S170T0U4981">s</span> &gt;= 0.5 &amp;&amp; <span class="var type0" id="S155T0U4984">s_sw</span> &gt;= 1)  || (<span class="var type0" id="S105T0U4989">obj</span>.t &gt;= 1.2*<span class="var type0" id="S159T0U4993">t_step</span>)) &amp;&amp; <span class="var type0" id="S105T0U4996">obj</span>.isTest11 == 0) || (<span class="var type0" id="S170T0U5002">s</span> &gt;= 1 &amp;&amp; <span class="var type0" id="S105T0U5006">obj</span>.isTest11 == 1)</span></span>
<span class="srcline"><span class="lineno"><a href="2,684" id="srcline684">684</a></span><span class="line">                <span class="comment">%       if s &gt;= 0.5 &amp;&amp; s_sw &gt;= 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,685" id="srcline685">685</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,686" id="srcline686">686</a></span><span class="line">                <span class="comment">% Save last step information</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,687" id="srcline687">687</a></span><span class="line">                <span class="var type0" id="S105T0U5012">obj</span>.dy_est_avg = (<span class="var type0" id="S105T0U5018">obj</span>.dy_est + <span class="var type0" id="S105T0U5021">obj</span>.dy_est_last)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,688" id="srcline688">688</a></span><span class="line">                <span class="var type0" id="S105T0U5027">obj</span>.dx_est_last = <span class="var type0" id="S105T0U5030">obj</span>.dx_est;</span></span>
<span class="srcline"><span class="lineno"><a href="2,689" id="srcline689">689</a></span><span class="line">                <span class="var type0" id="S105T0U5035">obj</span>.dy_est_last = <span class="var type0" id="S105T0U5038">obj</span>.dy_est;</span></span>
<span class="srcline"><span class="lineno"><a href="2,690" id="srcline690">690</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,691" id="srcline691">691</a></span><span class="line">                <span class="var type0" id="S105T0U5043">obj</span>.hd_last = [<span class="var type0" id="S197T0U5048">hd</span>(2);<span class="var type0" id="S197T0U5052">hd</span>(1);<span class="var type0" id="S197T0U5056">hd</span>(4);<span class="var type0" id="S197T0U5060">hd</span>(3)];</span></span>
<span class="srcline"><span class="lineno"><a href="2,692" id="srcline692">692</a></span><span class="line">                <span class="var type0" id="S105T0U5065">obj</span>.dhd_last = [<span class="var type0" id="S199T0U5070">dhd</span>(2);<span class="var type0" id="S199T0U5074">dhd</span>(1);<span class="var type0" id="S199T0U5078">dhd</span>(4);<span class="var type0" id="S199T0U5082">dhd</span>(3)];</span></span>
<span class="srcline"><span class="lineno"><a href="2,693" id="srcline693">693</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,694" id="srcline694">694</a></span><span class="line">                <span class="var type0" id="S105T0U5087">obj</span>.dq_yaw_last = <span class="var type0" id="S105T0U5090">obj</span>.dq_yaw;</span></span>
<span class="srcline"><span class="lineno"><a href="2,695" id="srcline695">695</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,696" id="srcline696">696</a></span><span class="line">                <span class="var type0" id="S105T0U5095">obj</span>.ds_last = <span class="var type0" id="S171T0U5097">ds</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,697" id="srcline697">697</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,698" id="srcline698">698</a></span><span class="line">                <span class="var type0" id="S105T0U5101">obj</span>.thetaMin = <span class="var type0" id="S135T0U5104">q_pitch</span> + (<span class="var type0" id="S127T0U5108">q_sw_lA</span>+<span class="var type0" id="S129T0U5109">q_sw_lB</span>)/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,699" id="srcline699">699</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,700" id="srcline700">700</a></span><span class="line">                <span class="comment">% Stair high believe update</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,701" id="srcline701">701</a></span><span class="line">                <span class="var type0" id="S249T0U5113">believeRate</span> = 0.2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,702" id="srcline702">702</a></span><span class="line">                <span class="keyword">if</span> <span class="var type0" id="S105T0U5119">obj</span>.stanceLeg == 1 <span class="comment">% Left</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,703" id="srcline703">703</a></span><span class="line">                    <span class="var type0" id="S105T0U5125">obj</span>.rightHeight = <span class="var type0" id="S142T0U5127">footHeight</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,704" id="srcline704">704</a></span><span class="line">                    <span class="var type0" id="S105T0U5131">obj</span>.rightBelieve = <span class="var type0" id="S249T0U5135">believeRate</span>*<span class="var type0" id="S105T0U5137">obj</span>.rightBelieve + (1-<span class="var type0" id="S249T0U5143">believeRate</span>)*<span class="var type0" id="S105T0U5145">obj</span>.rightHeight;</span></span>
<span class="srcline"><span class="lineno"><a href="2,705" id="srcline705">705</a></span><span class="line">                    <span class="keyword">if</span> <span class="var type0" id="S105T0U5151">obj</span>.isSim == 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,706" id="srcline706">706</a></span><span class="line">                        <span class="var type0" id="S105T0U5157">obj</span>.hBelieve = <span class="var type0" id="S105T0U5160">obj</span>.leftBelieve;</span></span>
<span class="srcline"><span class="lineno"><a href="2,707" id="srcline707">707</a></span><span class="line">                    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,708" id="srcline708">708</a></span><span class="line">                        <span class="var type0" id="S105T0U5166">obj</span>.hBelieve = <span class="var type0" id="S105T0U5169">obj</span>.leftBelieve;</span></span>
<span class="srcline"><span class="lineno"><a href="2,709" id="srcline709">709</a></span><span class="line">                    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,710" id="srcline710">710</a></span><span class="line">                <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,711" id="srcline711">711</a></span><span class="line">                    <span class="var type0" id="S105T0U5175">obj</span>.leftHeight = <span class="var type0" id="S142T0U5177">footHeight</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,712" id="srcline712">712</a></span><span class="line">                    <span class="var type0" id="S105T0U5181">obj</span>.leftBelieve = <span class="var type0" id="S249T0U5185">believeRate</span>*<span class="var type0" id="S105T0U5187">obj</span>.leftBelieve + (1-<span class="var type0" id="S249T0U5193">believeRate</span>)*<span class="var type0" id="S105T0U5195">obj</span>.leftHeight;</span></span>
<span class="srcline"><span class="lineno"><a href="2,713" id="srcline713">713</a></span><span class="line">                    <span class="keyword">if</span> <span class="var type0" id="S105T0U5201">obj</span>.isSim == 0</span></span>
<span class="srcline"><span class="lineno"><a href="2,714" id="srcline714">714</a></span><span class="line">                        <span class="var type0" id="S105T0U5207">obj</span>.hBelieve = <span class="var type0" id="S105T0U5210">obj</span>.rightBelieve;</span></span>
<span class="srcline"><span class="lineno"><a href="2,715" id="srcline715">715</a></span><span class="line">                    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,716" id="srcline716">716</a></span><span class="line">                        <span class="var type0" id="S105T0U5216">obj</span>.hBelieve = <span class="var type0" id="S105T0U5219">obj</span>.rightBelieve;</span></span>
<span class="srcline"><span class="lineno"><a href="2,717" id="srcline717">717</a></span><span class="line">                    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,718" id="srcline718">718</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,719" id="srcline719">719</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,720" id="srcline720">720</a></span><span class="line">                <span class="comment">% Swap leg, reset time</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,721" id="srcline721">721</a></span><span class="line">                <span class="var type0" id="S105T0U5224">obj</span>.stanceLeg = -<span class="var type0" id="S105T0U5228">obj</span>.stanceLeg;</span></span>
<span class="srcline"><span class="lineno"><a href="2,722" id="srcline722">722</a></span><span class="line">                <span class="var type0" id="S105T0U5233">obj</span>.t = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,723" id="srcline723">723</a></span><span class="line">                <span class="var type0" id="S105T0U5239">obj</span>.tauPhase = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,724" id="srcline724">724</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,725" id="srcline725">725</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,726" id="srcline726">726</a></span><span class="line">        <span class="keyword">end</span> <span class="comment">% userStep</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,727" id="srcline727">727</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,728" id="srcline728">728</a></span><span class="line">        <span class="keyword">function</span> parsePS3Controller(<span class="var type0" id="S251T0U5246">obj</span>,<span class="var type0" id="S252T0U5247">q</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,729" id="srcline729">729</a></span><span class="line">            <span class="comment">%PARSEPS3CONTROLLER</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,730" id="srcline730">730</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,731" id="srcline731">731</a></span><span class="line">            <span class="comment">% Parse D-Pad for velocity trimming</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,732" id="srcline732">732</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S251T0U5253">obj</span>.ps3.up.isPressed</span></span>
<span class="srcline"><span class="lineno"><a href="2,733" id="srcline733">733</a></span><span class="line">                <span class="comment">% Trim forward</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,734" id="srcline734">734</a></span><span class="line">                <span class="var type0" id="S251T0U5260">obj</span>.x_offset = <span class="var type0" id="S251T0U5264">obj</span>.x_offset - <span class="var type0" id="S251T0U5267">obj</span>.trimIncrement;</span></span>
<span class="srcline"><span class="lineno"><a href="2,735" id="srcline735">735</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5273">obj</span>.ps3.right.isPressed</span></span>
<span class="srcline"><span class="lineno"><a href="2,736" id="srcline736">736</a></span><span class="line">                <span class="comment">% Trim right</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,737" id="srcline737">737</a></span><span class="line">                <span class="var type0" id="S251T0U5280">obj</span>.y_offset = <span class="var type0" id="S251T0U5284">obj</span>.y_offset + <span class="var type0" id="S251T0U5287">obj</span>.trimIncrement;</span></span>
<span class="srcline"><span class="lineno"><a href="2,738" id="srcline738">738</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5293">obj</span>.ps3.down.isPressed</span></span>
<span class="srcline"><span class="lineno"><a href="2,739" id="srcline739">739</a></span><span class="line">                <span class="comment">% Trim backward</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,740" id="srcline740">740</a></span><span class="line">                <span class="var type0" id="S251T0U5300">obj</span>.x_offset = <span class="var type0" id="S251T0U5304">obj</span>.x_offset + <span class="var type0" id="S251T0U5307">obj</span>.trimIncrement;</span></span>
<span class="srcline"><span class="lineno"><a href="2,741" id="srcline741">741</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5313">obj</span>.ps3.left.isPressed</span></span>
<span class="srcline"><span class="lineno"><a href="2,742" id="srcline742">742</a></span><span class="line">                <span class="comment">% Trim left</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,743" id="srcline743">743</a></span><span class="line">                <span class="var type0" id="S251T0U5320">obj</span>.y_offset = <span class="var type0" id="S251T0U5324">obj</span>.y_offset - <span class="var type0" id="S251T0U5327">obj</span>.trimIncrement;</span></span>
<span class="srcline"><span class="lineno"><a href="2,744" id="srcline744">744</a></span><span class="line">            <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,745" id="srcline745">745</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,746" id="srcline746">746</a></span><span class="line">            <span class="comment">% Parse up trigger to do yaw control</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,747" id="srcline747">747</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S251T0U5334">obj</span>.ps3.l1.isPressed</span></span>
<span class="srcline"><span class="lineno"><a href="2,748" id="srcline748">748</a></span><span class="line">                <span class="var type0" id="S251T0U5341">obj</span>.q_yaw_tgt = <span class="var type0" id="S251T0U5345">obj</span>.q_yaw_tgt + 5/180*pi;</span></span>
<span class="srcline"><span class="lineno"><a href="2,749" id="srcline749">749</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5357">obj</span>.ps3.r1.isPressed</span></span>
<span class="srcline"><span class="lineno"><a href="2,750" id="srcline750">750</a></span><span class="line">                <span class="var type0" id="S251T0U5364">obj</span>.q_yaw_tgt = <span class="var type0" id="S251T0U5368">obj</span>.q_yaw_tgt - 5/180*pi;</span></span>
<span class="srcline"><span class="lineno"><a href="2,751" id="srcline751">751</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,752" id="srcline752">752</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,753" id="srcline753">753</a></span><span class="line">            <span class="comment">% Parse gait modes</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,754" id="srcline754">754</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S251T0U5381">obj</span>.ps3.cross.isPressed; <span class="var type0" id="S251T0U5388">obj</span>.gaitMode = GaitMode.Cross;</span></span>
<span class="srcline"><span class="lineno"><a href="2,755" id="srcline755">755</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5397">obj</span>.ps3.circle.isPressed; <span class="var type0" id="S251T0U5404">obj</span>.gaitMode = GaitMode.Circle;</span></span>
<span class="srcline"><span class="lineno"><a href="2,756" id="srcline756">756</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5413">obj</span>.ps3.triangle.isPressed; <span class="var type0" id="S251T0U5420">obj</span>.gaitMode = GaitMode.Triangle;</span></span>
<span class="srcline"><span class="lineno"><a href="2,757" id="srcline757">757</a></span><span class="line">            <span class="keyword">elseif</span> <span class="var type0" id="S251T0U5429">obj</span>.ps3.square.isPressed; <span class="var type0" id="S251T0U5436">obj</span>.gaitMode = GaitMode.Square;</span></span>
<span class="srcline"><span class="lineno"><a href="2,758" id="srcline758">758</a></span><span class="line">            <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,759" id="srcline759">759</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,760" id="srcline760">760</a></span><span class="line">            <span class="comment">% Parse select button for reset home</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,761" id="srcline761">761</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S251T0U5446">obj</span>.ps3.select.isPressed; <span class="var type0" id="S251T0U5453">obj</span>.x_est = 0; <span class="var type0" id="S251T0U5459">obj</span>.y_est = 0; <span class="var type0" id="S251T0U5465">obj</span>.yawReset = <span class="var type0" id="S252T0U5468">q</span>(12); <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,762" id="srcline762">762</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,763" id="srcline763">763</a></span><span class="line">            <span class="comment">% Parse left joystick data for X Velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,764" id="srcline764">764</a></span><span class="line">            <span class="var type0" id="S254T0U5472">dx_cmd</span> = clamp(<span class="var type0" id="S251T0U5477">obj</span>.ps3.leftStickY, -1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,765" id="srcline765">765</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,766" id="srcline766">766</a></span><span class="line">            <span class="comment">% Parse right joystick data for Y Velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,767" id="srcline767">767</a></span><span class="line">            <span class="var type0" id="S256T0U5485">dy_cmd</span> = clamp(<span class="var type0" id="S251T0U5490">obj</span>.ps3.rightStickX, -1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="2,768" id="srcline768">768</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,769" id="srcline769">769</a></span><span class="line">            <span class="comment">% Parse right joystick data for Y Velocity</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,770" id="srcline770">770</a></span><span class="line">            <span class="var type0" id="S251T0U5499">obj</span>.dq_yaw_tgt = clamp(<span class="var type0" id="S251T0U5508">obj</span>.ps3.rightStickY, -1, 1)*5*pi/180;</span></span>
<span class="srcline"><span class="lineno"><a href="2,771" id="srcline771">771</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,772" id="srcline772">772</a></span><span class="line">            <span class="comment">% Set gait mode specific tweaks</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,773" id="srcline773">773</a></span><span class="line">            <span class="keyword">if</span> 0  <span class="comment">% use PS3 controller</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,774" id="srcline774">774</a></span><span class="line">                <span class="keyword">switch</span> obj.gaitMode</span></span>
<span class="srcline"><span class="lineno"><a href="2,775" id="srcline775">775</a></span><span class="line">                    </span></span>
<span class="srcline"><span class="lineno"><a href="2,776" id="srcline776">776</a></span><span class="line">                    <span class="keyword">case</span> GaitMode.Cross</span></span>
<span class="srcline"><span class="lineno"><a href="2,777" id="srcline777">777</a></span><span class="line">                        <span class="comment">% Hold position mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,778" id="srcline778">778</a></span><span class="line">                        dx_cmd = clamp(-0.2*(cos(obj.q_yaw)*obj.x_est + sin(obj.q_yaw)*obj.y_est), -0.4, 0.4);</span></span>
<span class="srcline"><span class="lineno"><a href="2,779" id="srcline779">779</a></span><span class="line">                        dy_cmd = clamp(-0.2*(cos(obj.q_yaw)*obj.y_est - sin(obj.q_yaw)*obj.x_est), -0.2, 0.2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,780" id="srcline780">780</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="2,781" id="srcline781">781</a></span><span class="line">                    <span class="keyword">case</span> GaitMode.Circle</span></span>
<span class="srcline"><span class="lineno"><a href="2,782" id="srcline782">782</a></span><span class="line">                        <span class="comment">% Robust stand/walk mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,783" id="srcline783">783</a></span><span class="line">                        dx_cmd = 0.8*dx_cmd;</span></span>
<span class="srcline"><span class="lineno"><a href="2,784" id="srcline784">784</a></span><span class="line">                        dy_cmd = 0.2*dy_cmd;</span></span>
<span class="srcline"><span class="lineno"><a href="2,785" id="srcline785">785</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="2,786" id="srcline786">786</a></span><span class="line">                    <span class="keyword">case</span> GaitMode.Triangle</span></span>
<span class="srcline"><span class="lineno"><a href="2,787" id="srcline787">787</a></span><span class="line">                        <span class="comment">% Fast walk/run mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,788" id="srcline788">788</a></span><span class="line">                        dx_cmd = 0.6*dx_cmd;</span></span>
<span class="srcline"><span class="lineno"><a href="2,789" id="srcline789">789</a></span><span class="line">                        dy_cmd = 0.2*dy_cmd;</span></span>
<span class="srcline"><span class="lineno"><a href="2,790" id="srcline790">790</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="2,791" id="srcline791">791</a></span><span class="line">                    <span class="keyword">otherwise</span> <span class="comment">% GaitMode.Square</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,792" id="srcline792">792</a></span><span class="line">                        <span class="comment">% Auto hold in place mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,793" id="srcline793">793</a></span><span class="line">                        commandThreshold = 0.1;</span></span>
<span class="srcline"><span class="lineno"><a href="2,794" id="srcline794">794</a></span><span class="line">                        <span class="keyword">if</span> abs(obj.ps3.leftStickY) &gt; commandThreshold || abs(obj.ps3.rightStickX) &gt; commandThreshold</span></span>
<span class="srcline"><span class="lineno"><a href="2,795" id="srcline795">795</a></span><span class="line">                            obj.PressTime = obj.PressTime + obj.sampleInterval;</span></span>
<span class="srcline"><span class="lineno"><a href="2,796" id="srcline796">796</a></span><span class="line">                        <span class="keyword">elseif</span> abs(obj.dx_tgt) &gt; commandThreshold || abs(obj.dy_tgt) &gt; commandThreshold</span></span>
<span class="srcline"><span class="lineno"><a href="2,797" id="srcline797">797</a></span><span class="line">                            <span class="comment">%                obj.PressTime = obj.PressTime; % hold current time</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,798" id="srcline798">798</a></span><span class="line">                        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,799" id="srcline799">799</a></span><span class="line">                            obj.PressTime = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,800" id="srcline800">800</a></span><span class="line">                        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,801" id="srcline801">801</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="2,802" id="srcline802">802</a></span><span class="line">                        <span class="keyword">if</span> abs(obj.dx_tgt) &gt; commandThreshold &amp;&amp; obj.PressTime &gt;1</span></span>
<span class="srcline"><span class="lineno"><a href="2,803" id="srcline803">803</a></span><span class="line">                            obj.x_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,804" id="srcline804">804</a></span><span class="line">                        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,805" id="srcline805">805</a></span><span class="line">                        <span class="keyword">if</span> abs(obj.dy_tgt) &gt; commandThreshold &amp;&amp; obj.PressTime &gt;1</span></span>
<span class="srcline"><span class="lineno"><a href="2,806" id="srcline806">806</a></span><span class="line">                            obj.y_est = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,807" id="srcline807">807</a></span><span class="line">                        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,808" id="srcline808">808</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="2,809" id="srcline809">809</a></span><span class="line">                        <span class="keyword">if</span> abs(obj.ps3.leftStickY) &gt; commandThreshold &amp;&amp; obj.PressTime &gt; 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,810" id="srcline810">810</a></span><span class="line">                            dx_cmd = 0.6*dx_cmd;</span></span>
<span class="srcline"><span class="lineno"><a href="2,811" id="srcline811">811</a></span><span class="line">                        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,812" id="srcline812">812</a></span><span class="line">                            dx_cmd = clamp(-0.4*(cos(obj.q_yaw)*obj.x_est + sin(obj.q_yaw)*obj.y_est), -0.4, 0.4);</span></span>
<span class="srcline"><span class="lineno"><a href="2,813" id="srcline813">813</a></span><span class="line">                        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,814" id="srcline814">814</a></span><span class="line">                        <span class="keyword">if</span> abs(obj.ps3.rightStickX) &gt; commandThreshold &amp;&amp; obj.PressTime &gt; 1</span></span>
<span class="srcline"><span class="lineno"><a href="2,815" id="srcline815">815</a></span><span class="line">                            dy_cmd = 0.2*dy_cmd;</span></span>
<span class="srcline"><span class="lineno"><a href="2,816" id="srcline816">816</a></span><span class="line">                        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,817" id="srcline817">817</a></span><span class="line">                            dy_cmd = clamp(-0.2*(cos(obj.q_yaw)*obj.y_est - sin(obj.q_yaw)*obj.x_est), -0.2, 0.2);</span></span>
<span class="srcline"><span class="lineno"><a href="2,818" id="srcline818">818</a></span><span class="line">                        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,819" id="srcline819">819</a></span><span class="line">                        </span></span>
<span class="srcline"><span class="lineno"><a href="2,820" id="srcline820">820</a></span><span class="line">                <span class="keyword">end</span> <span class="comment">% switch</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,821" id="srcline821">821</a></span><span class="line">                </span></span>
<span class="srcline"><span class="lineno"><a href="2,822" id="srcline822">822</a></span><span class="line">                <span class="comment">%       % Simulation overrides</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,823" id="srcline823">823</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,824" id="srcline824">824</a></span><span class="line">                <span class="keyword">if</span> <span class="var type0" id="S251T0U5842">obj</span>.runTime &gt;20 &amp;&amp; <span class="var type0" id="S251T0U5847">obj</span>.runTime &lt;30</span></span>
<span class="srcline"><span class="lineno"><a href="2,825" id="srcline825">825</a></span><span class="line">                    <span class="var type0" id="S254T0U5852">dx_cmd</span> = 0.6;</span></span>
<span class="srcline"><span class="lineno"><a href="2,826" id="srcline826">826</a></span><span class="line">                <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,827" id="srcline827">827</a></span><span class="line">                    <span class="var type0" id="S254T0U5857">dx_cmd</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,828" id="srcline828">828</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,829" id="srcline829">829</a></span><span class="line">                <span class="var type0" id="S256T0U5861">dy_cmd</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="2,830" id="srcline830">830</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,831" id="srcline831">831</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,832" id="srcline832">832</a></span><span class="line">            <span class="comment">% Parse right lower trigger for turbo mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,833" id="srcline833">833</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S251T0U5868">obj</span>.ps3.r2.value</span></span>
<span class="srcline"><span class="lineno"><a href="2,834" id="srcline834">834</a></span><span class="line">                <span class="var type0" id="S254T0U5874">dx_cmd</span> = 2*<span class="var type0" id="S254T0U5877">dx_cmd</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,835" id="srcline835">835</a></span><span class="line">            <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,836" id="srcline836">836</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,837" id="srcline837">837</a></span><span class="line">            <span class="comment">% Parse left lower trigger for auto speed regulation mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,838" id="srcline838">838</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S251T0U5883">obj</span>.ps3.l2.value</span></span>
<span class="srcline"><span class="lineno"><a href="2,839" id="srcline839">839</a></span><span class="line">                <span class="keyword">if</span> abs(<span class="var type0" id="S251T0U5893">obj</span>.dy_est_avg) &gt;= 0.05</span></span>
<span class="srcline"><span class="lineno"><a href="2,840" id="srcline840">840</a></span><span class="line">                    <span class="var type0" id="S254T0U5898">dx_cmd</span> = <span class="var type0" id="S254T0U5900">dx_cmd</span>/2;</span></span>
<span class="srcline"><span class="lineno"><a href="2,841" id="srcline841">841</a></span><span class="line">                <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,842" id="srcline842">842</a></span><span class="line">            <span class="keyword">end</span> <span class="comment">% if</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,843" id="srcline843">843</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,844" id="srcline844">844</a></span><span class="line">            <span class="comment">% Filter target X velocity command</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,845" id="srcline845">845</a></span><span class="line">            <span class="var type0" id="S258T0U5904">alpha_dx</span> = <span class="var type0" id="S251T0U5907">obj</span>.sampleInterval/(2 + <span class="var type0" id="S251T0U5913">obj</span>.sampleInterval);</span></span>
<span class="srcline"><span class="lineno"><a href="2,846" id="srcline846">846</a></span><span class="line">            <span class="var type0" id="S251T0U5918">obj</span>.dx_tgt = <span class="var type0" id="S251T0U5922">obj</span>.dx_tgt + <span class="var type0" id="S258T0U5925">alpha_dx</span>*(<span class="var type0" id="S254T0U5928">dx_cmd</span> - <span class="var type0" id="S251T0U5930">obj</span>.dx_tgt);</span></span>
<span class="srcline"><span class="lineno"><a href="2,847" id="srcline847">847</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="2,848" id="srcline848">848</a></span><span class="line">            <span class="comment">% Filter target Y velocity command</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,849" id="srcline849">849</a></span><span class="line">            <span class="var type0" id="S259T0U5934">alpha_dy</span> = <span class="var type0" id="S251T0U5937">obj</span>.sampleInterval/(0.5 + <span class="var type0" id="S251T0U5943">obj</span>.sampleInterval);</span></span>
<span class="srcline"><span class="lineno"><a href="2,850" id="srcline850">850</a></span><span class="line">            <span class="var type0" id="S251T0U5948">obj</span>.dy_tgt = <span class="var type0" id="S251T0U5952">obj</span>.dy_tgt + <span class="var type0" id="S259T0U5955">alpha_dy</span>*(<span class="var type0" id="S256T0U5958">dy_cmd</span> - <span class="var type0" id="S251T0U5960">obj</span>.dy_tgt);</span></span>
<span class="srcline"><span class="lineno"><a href="2,851" id="srcline851">851</a></span><span class="line">        <span class="keyword">end</span> <span class="comment">% parsePS3Controller</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,852" id="srcline852">852</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="2,853" id="srcline853">853</a></span><span class="line">    <span class="keyword">end</span> <span class="comment">% methods</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,854" id="srcline854">854</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,855" id="srcline855">855</a></span><span class="line"><span class="keyword">end</span> <span class="comment">% classdef</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,856" id="srcline856">856</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,857" id="srcline857">857</a></span><span class="line"><span class="comment">%% LOCAL FUNCTIONS ========================================================</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,858" id="srcline858">858</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,859" id="srcline859">859</a></span><span class="line"><span class="keyword">function</span> <span class="var type0" id="S261T0U5964">s</span> = scaleFactor(<span class="var type0" id="S262T0U5967">f</span>, <span class="var type0" id="S263T0U5968">tl</span>, <span class="var type0" id="S264T0U5969">tu</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,860" id="srcline860">860</a></span><span class="line">    <span class="comment">%SCALEFACTOR Compute scalar (0 to 1) representing forces in leg.</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,861" id="srcline861">861</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,862" id="srcline862">862</a></span><span class="line">    <span class="var type0" id="S261T0U5972">s</span> = (clamp(<span class="var type0" id="S262T0U5978">f</span>, <span class="var type0" id="S263T0U5979">tl</span>, <span class="var type0" id="S264T0U5980">tu</span>) - <span class="var type0" id="S263T0U5981">tl</span>)/(<span class="var type0" id="S264T0U5984">tu</span> - <span class="var type0" id="S263T0U5985">tl</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,863" id="srcline863">863</a></span><span class="line"><span class="keyword">end</span> <span class="comment">% scaleFactor</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,864" id="srcline864">864</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,865" id="srcline865">865</a></span><span class="line"><span class="keyword">function</span> <span class="var type0" id="S267T0U5988">y</span> = atans(<span class="var type0" id="S268T0U5991">x</span>, <span class="var type0" id="S269T0U5992">slope</span>, <span class="var type0" id="S270T0U5993">y_lim</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="2,866" id="srcline866">866</a></span><span class="line">    <span class="comment">%ATANS Arctangent smooth clamp function</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,867" id="srcline867">867</a></span><span class="line">    <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,868" id="srcline868">868</a></span><span class="line">    <span class="comment">% Rescale Y limit for arctangent function</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,869" id="srcline869">869</a></span><span class="line">    <span class="var type0" id="S270T0U5996">y_lim</span> = <span class="var type0" id="S270T0U5999">y_lim</span>*2/pi;</span></span>
<span class="srcline"><span class="lineno"><a href="2,870" id="srcline870">870</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="2,871" id="srcline871">871</a></span><span class="line">    <span class="comment">% Arctangent scaled to have desired slope at 0 and desired clamp at Inf</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,872" id="srcline872">872</a></span><span class="line">    <span class="var type0" id="S267T0U6005">y</span> = <span class="var type0" id="S270T0U6007">y_lim</span>*atan(<span class="var type0" id="S269T0U6012">slope</span>*<span class="var type0" id="S268T0U6013">x</span>/<span class="var type0" id="S270T0U6014">y_lim</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="2,873" id="srcline873">873</a></span><span class="line"><span class="keyword">end</span> <span class="comment">% atans</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,874" id="srcline874">874</a></span><span class="line"> </span></span>
</pre>
</div>
